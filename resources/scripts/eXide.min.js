var eXide=eXide||{};eXide.namespace=function(a){var a=a.split("."),b=eXide,e;"eXide"==a[0]&&(a=a.slice(1));for(e=0;e<a.length;e++)"undefined"==typeof b[a[e]]&&(b[a[e]]={}),b=b[a[e]];return b};eXide.namespace("eXide.util");
eXide.util=function(){var a={dir1:"up",dir2:"left",firstpos1:15,firstpos2:15};$(document).ready(function(){$.pnotify.defaults.styling="jqueryui"});return{popup:function(b,a,c,d,f){function h(d){i&&(i.empty(),d.find(".tooltip").each(function(){i.html($(this).html())}))}var g=$(a),i=c?$(c):null,j=null;d.sort(function(d,a){return d.label==a.label?0:d.label>a.label?1:-1});g.empty();b=document.createElement("div");b.className="title";a=document.createElement("a");a.href="#";a.className="popup-close";a.appendChild(document.createTextNode("Close"));
b.appendChild(a);g.append(b);$(a).click(function(d){d.preventDefault();g.css("display","none");i&&i.css("display","none")});b=document.createElement("ul");for(a=0;a<d.length;a++){c=document.createElement("li");0==a&&(c.className="first");c.appendChild(document.createTextNode(d[a].label));if(d[a].tooltip){var l=document.createElement("span");l.className="tooltip";l.innerHTML=d[a].tooltip;c.appendChild(l)}b.appendChild(c);$(c).click(function(){j.removeClass("selection");$(this).addClass("selection");
j=$(this);h(j)});$(c).dblclick(function(){var a=g.find("li").index(j);g.css("display","none");i&&i.css("display","none");f.call(null,d[a])})}g.append(b);j=g.find("ul li:first").addClass("selection");h(j);var m=$(b).scrollTop(0),r=m.innerHeight();$(g).keydown(function(a){a.preventDefault();if(40==a.which)a=j.next(),0<a.length&&(j.removeClass("selection"),a.addClass("selection"),j=a,a.position().top+a.height()>=r&&a.get(0).scrollIntoView(),h(a));else if(38==a.which)a=j.prev(),0<a.length&&(j.removeClass("selection"),
a.addClass("selection"),j=a,a.hasClass("first")?m.scrollTop(0):0>a.position().top&&a.get(0).scrollIntoView(),h(a));else if(13==a.which){var b=g.find("li").index(j);g.css("display","none");i&&i.css("display","none");$(g).unbind(a);f.call(null,d[b])}else return g.css("display","none"),i&&i.css("display","none"),$(g).unbind(a),f.call(null,null),!0;return!1});g.fadeIn(80,function(){g.focus();i&&(i.css({top:m.offset().top-8+"px"}),i.fadeIn())})},supportsHtml5Storage:function(){try{return"localStorage"in
window&&null!==window.localStorage}catch(a){return!1}},normalizePath:function(a){if(!a)return a;for(var a=a.replace(/^xmldb:exist:\/\//,""),e=[],a=a.split("/"),c=a.length,d=0;d<c;d++)".."==a[d]?e.pop():e.push(a[d]);return e.join("/")},parseSignature:function(a){var e=a.indexOf("(");if(-1<e){var c=a.substring(0,e+1),a=a.substring(e);if(a=a.match(/\$[\w:-_]+/g))for(e=0;e<a.length;e++)0<e&&(c+=", "),c+=a[e];return c+")"}return a},message:function(b){$.pnotify({text:b,shadow:!0,hide:!0,closer:!0,opacity:0.65,
addclass:"stack-bottomright custom",stack:a})},success:function(b){$.pnotify({text:b,shadow:!0,type:"success",hide:!0,closer:!0,opacity:0.65,addclass:"stack-bottomright custom",stack:a})},error:function(b,e){var c={text:b,type:"error",shadow:!0,hide:!0,addclass:"stack-bottomright custom",stack:a};e&&(c.title=e);$.pnotify(c)}}}();eXide.namespace("eXide.util.Dialog");
eXide.util.Dialog=function(){var a,b=null;$(document).ready(function(){$(document.body).append('<div id="eXide-dialog-message">\t<img id="eXide-dialog-message-icon" src="resources/images/error.png"/>\t<div id="eXide-dialog-message-body"></div></div>');a=$("#eXide-dialog-message");a.dialog({modal:!0,autoOpen:!1,buttons:{OK:function(){$(this).dialog("close")}}});$(document.body).append('<div id="eXide-dialog-input">\t<img id="eXide-dialog-input-icon" src="resources/images/information.png"/>\t<div id="eXide-dialog-input-body"></div></div>');
inputDialog=$("#eXide-dialog-input");inputDialog.dialog({modal:!0,autoOpen:!1,buttons:{OK:function(){$(this).dialog("close");null!=b&&b.apply($("eXide-dialog-input-body"),[])},Cancel:function(){$(this).dialog("close")}}})});return{message:function(b,c){null==c&&(c="");a.dialog("option","title",b);$("#eXide-dialog-message-body").html(c);$("#eXide-dialog-message-icon").attr("src","resources/images/information.png");a.dialog("open")},warning:function(b,c){null==c&&(c="");a.dialog("option","title",b);
$("#eXide-dialog-message-body").html(c);$("#eXide-dialog-message-icon").attr("src","resources/images/error.png");a.dialog("open")},input:function(a,c,d){b=d;inputDialog.dialog("option","title",a);$("#eXide-dialog-input-body").html(c);inputDialog.dialog("open")}}}();eXide.namespace("eXide.util.mimeTypes");
eXide.util.mimeTypes=function(){var a={xml:["text/xml","application/xml","application/xhtml+xml","application/atom+xml"],xquery:["application/xquery"],css:["text/css"],html:["text/html"],javascript:["application/x-javascript"],text:["text/text"],less:["application/less"]};return{getMime:function(a){var e=a.indexOf(";");-1<e&&(a=a.substring(0,e));return a},getLangFromMime:function(b){for(var e in a)for(var c=a[e],d=0;d<c.length;d++)if(b==c[d])return e;return"xquery"},getMimeFromLang:function(b){return(b=
a[b])?b[0]:"application/xquery"}}}();eXide.namespace("eXide.util.oop");eXide.util.oop.inherit=function(){var a=function(){};return function(b,e){a.prototype=e.prototype;b.prototype=new a;b.super_=e.prototype;b.prototype.constructor=b}}();eXide.util.oop.extend=function(){return function(a,b){for(var e in b)b.hasOwnProperty(e)&&(a[e]=b[e])}}();
(function(a){a.log=function(){window.console&&window.console.log&&Function.prototype.bind.call(console.log,console).apply(console,arguments)};a.fn.log=function(){a.log(this);return this}})(jQuery);define("eXide/mode/xquery_highlight_rules",function(a,b){var e=a("ace/lib/oop"),c=a("ace/lib/lang"),d=a("ace/mode/text_highlight_rules").TextHighlightRules,f=function(){var a=c.arrayToMap("return for let where order by declare function variable xquery version option namespace import module switch default map if then else as and or typeswitch case ascending descending empty in".split(" "));this.$rules={start:[{token:"text",regex:"<\\!\\[CDATA\\[",next:"cdata"},{token:"xml_pe",regex:"<\\?.*?\\?>"},
{token:"comment",regex:"<\\!--",next:"comment"},{token:"comment",regex:"\\(:",next:"comment"},{token:"text",regex:"<\\/?",next:"tag"},{token:"constant",regex:"[+-]?\\d+(?:(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)?\\b"},{token:"variable",regex:"\\$[a-zA-Z_][a-zA-Z0-9_\\-:]*\\b"},{token:"string",regex:'".*?"'},{token:"string",regex:"'.*?'"},{token:"text",regex:"\\s+"},{token:"comment",regex:"\\%\\w[\\w+_\\-:]+\\b"},{token:"support.function",regex:"\\w[\\w+_\\-:]+(?=\\()"},{token:"keyword.operator",regex:"\\*|=|<|>|\\-|\\+|and|or|eq|ne|lt|gt"},
{token:"lparen",regex:"[[({]"},{token:"rparen",regex:"[\\])}]"},{token:function(d){return a[d]?"keyword":"identifier"},regex:"[a-zA-Z_$][a-zA-Z0-9_$]*\\b"}],tag:[{token:"text",regex:">",next:"start"},{token:"keyword",regex:"[-_a-zA-Z0-9:]+"},{token:"text",regex:"\\s+"},{token:"string",regex:'".*?"'},{token:"string",regex:"'.*?'"}],cdata:[{token:"text",regex:"\\]\\]>",next:"start"},{token:"text",regex:"\\s+"},{token:"text",regex:"(?:[^\\]]|\\](?!\\]>))+"}],comment:[{token:"comment",regex:".*?--\>",
next:"start"},{token:"comment",regex:".*:\\)",next:"start"},{token:"comment",regex:".+"}]}};e.inherits(f,d);b.XQueryHighlightRules=f});
define("eXide/mode/behaviour/xquery",function(a,b){var e=a("ace/lib/oop"),c=a("ace/mode/behaviour").Behaviour,d=a("ace/mode/behaviour/cstyle").CstyleBehaviour,f=function(a){this.inherit(d,["braces","parens","string_dquotes"]);this.parent=a;this.add("brackets","insertion",function(a,d,b,f,e){return"\n"==e&&(d=b.getCursorPosition(),"</"==f.doc.getLine(d.row).substring(d.column,d.column+2))?(a=this.$getIndent(f.doc.getLine(d.row))+f.getTabString(),f=this.$getIndent(f.doc.getLine(d.row)),{text:"\n"+a+
"\n"+f,selection:[1,a.length,1,a.length]}):!1});this.add("comments","insertion",function(a,d,b,f,e){a=b.getCursorPosition();f=f.doc.getLine(a.row);if("\n"==e&&f.match(/^[\(\s]:/))return{text:"\n : ",selection:[1,3,1,3]};if(":"==e&&"("==f.substring(a.column-1,1))return $.log("cursor: %d",a.column),{text:":  :",selection:[2,2]}});this.add("slash","insertion",function(d,b,f,e,c){"/"==c&&(d=f.getCursorPosition(),b=e.doc.getLine(d.row),0<d.column&&"<"==b.charAt(d.column-1)&&(b=b.substring(0,d.column)+
"/"+b.substring(d.column),f=e.doc.getAllLines(),f[d.row]=b,a.exec("closeTag",f.join(e.doc.getNewLineCharacter()),d.row)));return!1})};e.inherits(f,c);b.XQueryBehaviour=f});
define("eXide/mode/xquery",function(a,b){var e=a("ace/lib/oop"),c=a("ace/mode/text").Mode,d=a("xqlint/XQueryLexer").XQueryLexer;a("ace/tokenizer");var f=a("eXide/mode/behaviour/xquery").XQueryBehaviour,h=a("ace/mode/folding/cstyle").FoldMode,g=a("ace/range").Range,i=function(a){this.$tokenizer=new d;this.$behaviour=new f(a);this.foldingRules=new h};e.inherits(i,c);(function(){this.getNextLineIndent=function(a,d,b){a=this.$getIndent(d);d.match(/\s*(?:then|else|return|[{\(]|<\w+>)\s*$/)&&(a+=b);return a};
this.checkOutdent=function(a,d,b){return!/^\s+$/.test(d)?!1:/^\s*[\}\)]/.test(b)};this.autoOutdent=function(a,d,b){a=d.getLine(b).match(/^(\s*[\}\)])/);if(!a)return 0;var a=a[1].length,f=d.findMatchingBracket({row:b,column:a});if(!f||f.row==b)return 0;f=this.$getIndent(d.getLine(f.row));d.replace(new g(b,0,b,a-1),f)};this.$getIndent=function(a){return(a=a.match(/^(\s+)/))?a[1]:""};this.toggleCommentLines=function(a,d,b,f){for(var e=!0,c=/^\s*\(:(.*):\)/,a=b;a<=f;a++)if(!c.test(d.getLine(a))){e=!1;
break}for(var i=new g(0,0,0,0),a=b;a<=f;a++)b=d.getLine(a),i.start.row=a,i.end.row=a,i.end.column=b.length,d.replace(i,e?b.match(c)[1]:"(:"+b+":)")}}).call(i.prototype);b.Mode=i});
define("eXide/mode/behaviour/xml",function(a,b){function e(a,d){var b=!0,f=a.type.split(".");d.split(".").forEach(function(a){if(-1==f.indexOf(a))return b=!1});return b}var c=a("ace/lib/oop"),d=a("ace/mode/behaviour").Behaviour,f=a("ace/mode/behaviour/cstyle").CstyleBehaviour,h=a("ace/token_iterator").TokenIterator,g=function(a){this.inherit(f,["braces","parens","string_dquotes"]);this.parent=a;this.add("brackets","insertion",function(a,d,b,f,e){return"\n"==e&&(d=b.getCursorPosition(),"</"==f.doc.getLine(d.row).substring(d.column,
d.column+2))?(a=this.$getIndent(f.doc.getLine(d.row))+f.getTabString(),f=this.$getIndent(f.doc.getLine(d.row)),{text:"\n"+a+"\n"+f,selection:[1,a.length,1,a.length]}):!1});this.add("slash","insertion",function(d,b,f,e,c){"/"==c&&(d=f.getCursorPosition(),b=e.doc.getLine(d.row),0<d.column&&"<"==b.charAt(d.column-1)&&(b=b.substring(0,d.column)+"/"+b.substring(d.column),f=e.doc.getAllLines(),f[d.row]=b,a.exec("closeTag",f.join(e.doc.getNewLineCharacter()),d.row)));return!1});this.add("autoclosing","insertion",
function(a,d,b,f,c){if(">"==c){a=b.getCursorPosition();b=new h(f,a.row,a.column);f=b.getCurrentToken();d=!1;if(!f||!e(f,"meta.tag")&&(!e(f,"text")||!f.value.match("/"))){do f=b.stepBackward();while(f&&(e(f,"string")||e(f,"keyword.operator")||e(f,"entity.attribute-name")||e(f,"text")))}else d=!0;if(f&&e(f,"meta.tag-name")&&!b.stepBackward().value.match("/"))return b=f.value,d&&(b=b.substring(0,a.column-f.start)),{text:"></"+b+">",selection:[1,1]}}})};c.inherits(g,d);b.XMLBehaviour=g});
define("eXide/mode/xml",function(a,b){var e=a("ace/lib/oop"),c=a("ace/mode/xml").Mode,d=a("ace/tokenizer").Tokenizer,f=a("ace/mode/xml_highlight_rules").XmlHighlightRules,h=a("ace/mode/folding/xml").FoldMode,g=a("eXide/mode/behaviour/xml").XMLBehaviour,i=a("ace/range").Range,j=function(a){this.$tokenizer=new d((new f).getRules());this.$behaviour=new g(a);this.foldingRules=new h};e.inherits(j,c);(function(){this.toggleCommentLines=function(a,d,b,f){for(var e=!0,c=/^\s*<\!--(.*)--\>/,a=b;a<=f;a++)if(!c.test(d.getLine(a))){e=
!1;break}for(var g=new i(0,0,0,0),a=b;a<=f;a++)b=d.getLine(a),g.start.row=a,g.end.row=a,g.end.column=b.length,d.replace(g,e?b.match(c)[1]:"<\!--"+b+"--\>")}}).call(j.prototype);b.Mode=j});
define("eXide/mode/html",function(a,b){var e=a("ace/lib/oop"),c=a("ace/mode/html").Mode,d=a("ace/tokenizer").Tokenizer,f=a("ace/mode/html_highlight_rules").HtmlHighlightRules,h=a("ace/mode/folding/html").FoldMode,g=a("eXide/mode/behaviour/xml").XMLBehaviour,i=a("ace/range").Range,j=a("ace/mode/javascript").Mode,l=a("ace/mode/css").Mode,m=function(a){var b=new f;this.$tokenizer=new d(b.getRules());this.$behaviour=new g(a);this.foldingRules=new h;this.$embeds=b.getEmbeds();this.createModeDelegates({"js-":j,
"css-":l})};e.inherits(m,c);(function(){this.toggleCommentLines=function(a,d,b,f){for(var e=!0,c=/^\s*<\!--(.*)--\>/,a=b;a<=f;a++)if(!c.test(d.getLine(a))){e=!1;break}for(var g=new i(0,0,0,0),a=b;a<=f;a++)b=d.getLine(a),g.start.row=a,g.end.row=a,g.end.column=b.length,d.replace(g,e?b.match(c)[1]:"<\!--"+b+"--\>")}}).call(m.prototype);b.Mode=m});eXide.namespace("eXide.events.Sender");eXide.events.Sender=function(){Constr=function(){};Constr.prototype={addEventListener:function(a,b,e){"function"==typeof b&&(e=b,b=null);this.events=this.events||{};var c=this.events[a];c||(c=[],this.events[a]=c);c.push({obj:b,callback:e})},$triggerEvent:function(a,b){this.events=this.events||{};var e=this.events[a];if(e)for(var c=0;c<e.length;c++)e[c].callback.apply(e[c].obj,b)}};return Constr}();eXide.namespace("eXide.edit.commands");
eXide.edit.commands=function(){function a(a){return{win:a[0],mac:a[1],sender:"editor"}}var b=require("ace/lib/useragent"),e={};return{init:function(c){var d=c.editor.commands;$.ajax({url:"keybindings.js",dataType:"json",async:!1,success:function(f){d.addCommand({name:"gotoLine",bindKey:a(f.gotoLine),exec:function(){c.gotoLine()}});d.addCommand({name:"fold",bindKey:a(f.fold),exec:function(a){a.editor.session.toggleFold(!1)},readOnly:!0});d.addCommand({name:"unfold",bindKey:a(f.unfold),exec:function(a){a.editor.session.toggleFold(!0)},
readOnly:!0});d.addCommand({name:"saveDocument",bindKey:a(f.saveDocument),exec:function(){eXide.app.saveDocument()}});d.addCommand({name:"runQuery",bindKey:a(f.runQuery),exec:function(){eXide.app.runQuery()}});d.addCommand({name:"openDocument",bindKey:a(f.openDocument),exec:function(){eXide.app.openDocument()}});d.addCommand({name:"newDocumentFromTemplate",bindKey:a(f.newDocumentFromTemplate),exec:function(){eXide.app.newDocumentFromTemplate()}});d.addCommand({name:"closeDocument",bindKey:a(f.closeDocument),
exec:function(){eXide.app.closeDocument()}});d.addCommand({name:"autocomplete",bindKey:a(f.autocomplete),exec:function(){c.autocomplete()}});d.addCommand({name:"nextTab",bindKey:a(f.nextTab),exec:function(){c.nextTab()}});d.addCommand({name:"previousTab",bindKey:a(f.previousTab),exec:function(){c.previousTab()}});d.addCommand({name:"formatCode",bindkey:a(f.formatCode),exec:function(){$.log("Formatting");c.exec("format")}});d.addCommand({name:"functionDoc",bindKey:a(f.functionDoc),exec:function(){c.exec("showFunctionDoc")}});
d.addCommand({name:"gotoDefinition",bindKey:a(f.gotoDefinition),exec:function(){c.exec("gotoDefinition")}});d.addCommand({name:"searchIncremental",bindKey:a(f.searchIncremental),exec:function(){c.quicksearch.start()}});d.addCommand({name:"searchReplace",bindKey:a(f.searchReplace),exec:function(){c.search.open()}});d.addCommand({name:"findModule",bindKey:a(f.findModule),exec:function(){var a=c.getActiveDocument();eXide.find.Modules.select(a.syntax)}});d.addCommand({name:"indentOrParam",bindKey:a(f.indentOrParam),
exec:function(){var a=c.getActiveDocument();(!a.template||!a.template.nextParam())&&c.editor.indent()}});d.addCommand({name:"escape",bindKey:a(f.escape),exec:function(){c.getActiveDocument().template=null;c.editor.clearSelection()}});d.addCommand({name:"dbManager",bindKey:a(f.dbManager),exec:function(){eXide.app.manage()}});d.addCommand({name:"toggleComment",bindKey:a(f.toggleComment),exec:function(){c.editor.toggleCommentLines()}});d.addCommand({name:"synchronize",bindKey:a(f.synchronize),exec:function(){eXide.app.synchronize()}});
d.addCommand({name:"preferences",bindKey:a(f.preferences),exec:function(){eXide.app.showPreferences()}});d.addCommand({name:"openApp",bindKey:a(f.openApp),exec:function(){eXide.app.openApp()}});f=c.editor.commands;for(key in f.commands){var h=f.commands[key],g;h.bindKey&&(g=b.isMac?h.bindKey.mac:h.bindKey.win);e[h.name]=g}}})},help:function(a,d){$(a).find("table").each(function(){this.innerHTML="";var a=d.editor.commands;for(key in a.commands){var e=a.commands[key],c=document.createElement("tr"),
i=document.createElement("td");i.appendChild(document.createTextNode(e.name));c.appendChild(i);i=document.createElement("td");e.bindKey&&(b.isMac?i.appendChild(document.createTextNode(e.bindKey.mac)):i.appendChild(document.createTextNode(e.bindKey.win)));c.appendChild(i);this.appendChild(c)}})},getShortcut:function(a){return e[a]}}}();eXide.namespace("eXide.edit.ModeHelper");
eXide.edit.ModeHelper=function(){Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.commands={};this.addCommand("locate",this.locate)};Constr.prototype={activate:function(){},deactivate:function(){},addCommand:function(a,b){this.commands||(this.commands={});this.commands[a]=b},exec:function(a,b,e){if(this.commands&&this.commands[a]){for(var b=[b],c=0;c<e.length;c++)b.push(e[c]);$.log("Calling command %s ...",a);this.commands[a].apply(this,b)}else eXide.util.message(a+" not supported in this mode.")},
createOutline:function(){d3.select("#outline").selectAll("li").transition().duration(400).style("opacity",0).remove()},documentSaved:function(){},locate:function(a,b,e){"number"==typeof e&&(this.editor.gotoLine(e+1),this.editor.focus());return!1}};return Constr}();eXide.namespace("eXide.edit.XQueryModeHelper");
eXide.edit.XQueryModeHelper=function(){function a(a){var d;d=a.line?a["#text"]:a;var b=g.exec(d),f=-1;b?f=parseInt(b[1])-1:a.line&&(f=parseInt(a.line)-1);return{line:f,msg:d}}var b=/^[\$\w:\-_\.]+/,e=require("xqlint/visitors/SemanticHighlighter").SemanticHighlighter,c=require("xqlint/XQueryParser").XQueryParser,d=require("xqlint/JSONParseTreeHandler").JSONParseTreeHandler,f=require("xqlint/Translator").Translator,h=require("xqlint/visitors/CodeFormatter").CodeFormatter;Constr=function(a,d){this.parent=
a;this.editor=this.parent.editor;this.xqDebugger=null;this.funcDefRe=/declare\s+((?:%[\w\:\-]+(?:\([^\)]*\))?\s*)*)function\s+([^\(]+)\(/g;this.varDefRe=/declare\s+(?:%\w+\s+)*variable\s+\$[^\s;]+/gm;this.varRe=/declare\s+(?:%\w+\s+)*variable\s+(\$[^\s;]+)/;this.parseImportRe=/import\s+module\s+namespace\s+[^=]+\s*=\s*["'][^"']+["']\s*at\s+["'][^"']+["']\s*;/g;this.moduleRe=/import\s+module\s+namespace\s+([^=\s]+)\s*=\s*["']([^"']+)["']\s*at\s+["']([^"']+)["']\s*;/;this.trimRe=/^[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u2028\u2029\u202f\u205f\u3000]+|[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u2028\u2029\u202f\u205f\u3000]+$/g;
this.addCommand("format",this.format);this.addCommand("showFunctionDoc",this.showFunctionDoc);this.addCommand("gotoDefinition",this.gotoDefinition);this.addCommand("locate",this.locate);this.addCommand("closeTag",this.closeTag);this.addCommand("importModule",this.importModule);this.addCommand("debug",this.initDebugger);this.addCommand("stepOver",this.stepOver);this.addCommand("stepInto",this.stepInto);var b=this;this.menu=$("#menu-xquery").hide();d.click("#menu-xquery-format",function(){b.format(a.getActiveDocument())},
"formatCode");a.addEventListener("change",function(){})};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.activate=function(){this.menu.show();this.parent.triggerCheck()};Constr.prototype.deactivate=function(){this.menu.hide()};Constr.prototype.closeTag=function(d,b,f){var d="xmldb:exist://"+d.getBasePath(),e=this;$.ajax({type:"POST",url:"modules/compile.xql",data:{q:b,base:d},dataType:"json",success:function(d){"fail"==d.result&&(d=a(d.error),d.line<=f&&(d=/constructor:\s(.*)$/.exec(d.msg),
0<d.length&&e.editor.insert(d[1]+">")))},error:function(){}})};Constr.prototype.validate=function(a,d,b){$.log("Running validation on %s",a.getName());var f=this,e="xmldb:exist://"+a.getBasePath();$.ajax({type:"POST",url:"modules/compile.xql",data:{q:d,base:e},dataType:"json",success:function(d){f.compileError(d,a);f.xqlint(a);b&&b.call(this,!0)},error:function(a,d){b&&b.call(this,!0);$.log("Compile error: %s - %s",d,a.responseText)}})};Constr.prototype.compileError=function(d,b){if("fail"==d.result){var f=
a(d.error),e={row:f.line,text:f.msg,type:"error"};this.parent.updateStatus(f.msg,b.getPath()+"#"+f.line);f=this.clearAnnotations(b,"error");f.push(e);b.getSession().setAnnotations(f)}else b.getSession().setAnnotations(this.clearAnnotations(b,"error")),this.parent.updateStatus("")};Constr.prototype.xqlint=function(a){var b=a.getSession(),g=a.getText(),h=new d(g),r=new c(g,h);try{r.parse_XQuery();var q=h.getParseTree(),v=new e(q,g),s=a.getSession().getMode();s.$tokenizer.tokens=v.getTokens();s.$tokenizer.lines=
b.getDocument().getAllLines();b.bgTokenizer.lines=[];b.bgTokenizer.states=[];for(var p=Object.keys(s.$tokenizer.tokens),g=0;g<p.length;g++){var o=parseInt(p[g]);b.bgTokenizer.fireUpdateEvent(o,o)}for(var q=(new f(q)).translate(),n=q.markers,u=this.clearAnnotations(a,"warning"),g=0;g<n.length;g++)"error"!==n[g].type&&u.push({row:n[g].pos.sl,text:n[g].message,type:n[g].type});b.setAnnotations(u)}catch(t){if($.log("error: %o",t),!(t instanceof r.ParseException))throw t;}};Constr.prototype.clearAnnotations=
function(a,d){for(var b=[],f=a.getSession().getAnnotations(),e=0;e<f.length;e++)f[e].type!==d&&b.push(f[e]);return b};Constr.prototype.autocomplete=function(a){require("pilot/lang");for(var d=require("ace/range").Range,b=this.editor.getSelection(),f=a.getSession(),b=b.getSelectionLead(),f=f.getDisplayLine(b.row),e=b.column-1,c=b.column;0<=e;){var g=f.substring(e,c);if(g.match(/^\$[\w:\-_\.]+$/))break;if(!g.match(/^[\w:\-_\.]+$/)){e++;break}e--}f=f.substring(e,c);$.log("completing token: %s",f);d=
new d(b.row,e,b.row,c);b=this.editor.renderer.textToScreenCoordinates(b.row,b.column);e=this.parent.getHeight();b.pageY+150>e&&(b.pageY=e-150);$("#autocomplete-box").css({left:b.pageX+"px",top:b.pageY+10+"px"});$("#autocomplete-help").css({left:b.pageX+324+"px",top:b.pageY+10+"px"});0==f.length?this.templateLookup(a,f,d,!0):this.functionLookup(a,f,d,!0);return!0};Constr.prototype.$localVars=function(a,d){for(var b=[],f=/declare function|};/,e=/let \$[\w\-_\:]+|for \$[\w\-_\:]+|\$[\w\-_\:]+\)/,c=/\$[\w\-_\:]+/,
g=RegExp("^\\"+a),h=this.editor.getSession(),p=d.start.row;-1<p;){var o=h.getDisplayLine(p),n;if(n=o.match(e))$.log("Var: %s",n[0]),n=n[0].match(c),n[0].match(g)&&b.push({name:n[0],type:"variable"});if(o.match(f)){$.log("Stop: %s",o);break}p--}return b};Constr.prototype.functionLookup=function(a,d,b,f){var e=this;$.ajax({url:"modules/docs.xql",dataType:"text",type:"POST",data:{prefix:d},success:function(c){var c=$.parseJSON(c),g=[],h;"$"==d.substring(0,1)?(h="^\\"+d,g=e.$localVars(d,b,f)):h="^"+d;
var p=RegExp(h);$.each(a.functions,function(a,d){d.name.match(p)&&g.push(d)});c&&(g=g.concat(c));c=[];for(h=0;h<g.length;h++){var o={label:g[h].signature?g[h].signature:g[h].name,type:g[h].type};g[h].help&&(o.tooltip=g[h].help);c.push(o)}e.$addTemplates(d,c);e.$showPopup(a,b,c)},error:function(a,d){eXide.util.error(d)}})};Constr.prototype.templateLookup=function(a,d,b){var f=[];this.$addTemplates(d,f);this.$showPopup(a,b,f)};Constr.prototype.$addTemplates=function(a,d){for(var b=this.parent.outline.getTemplates(a),
f=0;f<b.length;f++)d.push({type:"template",label:"[S] "+b[f].name,tooltip:b[f].help,template:b[f].template})};Constr.prototype.$showPopup=function(a,d,b){var f=this;eXide.util.popup(this.editor,$("#autocomplete-box"),$("#autocomplete-help"),b,function(b){if(b){var e=b.label;"template"==b.type?e=b.template:"function"==b.type&&(e=eXide.util.parseSignature(e));a.template=new eXide.edit.Template(f.parent,d,e,b.type);a.template.insert()}f.editor.focus()})};Constr.prototype.getFunctionAtCursor=function(a){var d=
a.row,d=this.editor.getSession().getDisplayLine(d),f=a.column;do f--;while(0<=f&&d.charAt(f).match(b));f++;for(a=a.column;a<d.length&&d.charAt(a).match(b);)a++;return d.substring(f,a)};Constr.prototype.showFunctionDoc=function(a){var d=this.editor.getSelection().getSelectionLead(),b=this.editor.renderer.textToScreenCoordinates(d.row,d.column);$("#autocomplete-box").css({left:b.pageX+"px",top:b.pageY+20+"px"});$("#autocomplete-help").css({left:b.pageX+324+"px",top:b.pageY+20+"px"});d=this.getFunctionAtCursor(d);
this.functionLookup(a,d,null,!1)};Constr.prototype.gotoDefinition=function(a){var d=this.editor.getSelection().getSelectionLead();(d=this.getFunctionAtCursor(d))&&this.parent.outline.gotoDefinition(a,d)};Constr.prototype.locate=function(a,d,b){switch(d){case "function":this.gotoFunction(a,b);break;default:this.gotoVarDecl(a,b)}};Constr.prototype.format=function(a){var b=a.getText(),f=new d(b);(new c(b,f)).parse_XQuery();b=f.getParseTree();b=(new h(b)).format();a.setText(b)};Constr.prototype.gotoFunction=
function(a,d){$.log("Goto function %s",d);var b=this.getModuleNamespacePrefix();null!=b&&(d=d.replace(/[^:]+:/,b+":"));var f=a.$session.getLength(),e=function(d){for(var b=0;b<f;b++)if(a.$session.getLine(b).match(d))return b};if((b=e(RegExp("function\\s+"+d+"\\s*\\(")))||(b=e(RegExp("function\\s+"+d+"$"))))return this.editor.gotoLine(b+1),this.editor.focus()};Constr.prototype.gotoVarDecl=function(a,d){var b=this.getModuleNamespacePrefix();null!=b&&(d=d.replace(/[^:]+:/,"$"+b+":"));$.log("Goto variable declaration %s",
d);for(var b=RegExp("variable\\s+\\"+d),f=a.$session.getLength(),e=0;e<f;e++)if(a.$session.getLine(e).match(b)){this.editor.gotoLine(e+1);this.editor.focus();break}};Constr.prototype.getModuleNamespacePrefix=function(){for(var a=/^\s*module\s+namespace\s+([^=\s]+)\s*=/,d=this.parent.getActiveDocument().$session.getLength(),b=0;b<d;b++){var f=this.parent.getActiveDocument().$session.getLine(b).match(a);if(f)return f[1]}return null};Constr.prototype.importModule=function(a,d,b,f){$.log("location = %s path = %s",
f,a.path);a=a.getBasePath();f=0===f.lastIndexOf(a,0)?f.substring(a.length+1):"xmldb:exist://"+f;this.editor.insert("import module namespace "+d+'="'+b+'" at "'+f+'";\n')};Constr.prototype.createOutline=function(a,d){var b=a.getText();this.$parseLocalFunctions(b,a);d&&d(a);(b=this.$parseImports(b))&&this.$resolveImports(a,b,d)};Constr.prototype.$sortFunctions=function(a){a.functions.sort(function(a,d){return a.source&&!d.source?1:d.source&&!a.source?-1:a.name==d.name?0:a.name>d.name?1:-1})};Constr.prototype.$parseLocalFunctions=
function(a,d){for(d.functions=[];;){var b=this.funcDefRe.exec(a);if(null==b)break;var f=this.funcDefRe.lastIndex,e=this.$findMatchingParen(a,f),c=(3==b.length?b[2]:b[1]).replace(this.trimRe,""),b=3==b.length?b[1]:"public",f=c+"("+a.substring(f,e)+")";-1!==b.indexOf("%private")&&(b="private");d.functions.push({type:eXide.edit.Document.TYPE_FUNCTION,name:c,visibility:b,signature:f,sort:"$$"+f})}if(c=a.match(this.varDefRe))for(f=0;f<c.length;f++)e=this.varRe.exec(c[f]),b=e[1].substr(1).split(":"),b.splice(1,
0,":$"),d.functions.push({type:eXide.edit.Document.TYPE_VARIABLE,name:e[1],sort:"$$"+b.join("")});this.$sortFunctions(d)};Constr.prototype.$findMatchingParen=function(a,d){for(var b=1,f=d;f<a.length;f++){var e=a.charAt(f);if(")"==e){if(b-=1,0==b)return f}else"("==e&&(b+=1)}return-1};Constr.prototype.$parseImports=function(a){return a.match(this.parseImportRe)};Constr.prototype.$resolveImports=function(a,d,b){for(var f=this,e=[],c=[],g=0;g<d.length;g++){var h=this.moduleRe.exec(d[g]);null!=h&&4==h.length&&
(c.push("prefix="+encodeURIComponent(h[1])),c.push("uri="+encodeURIComponent(h[2])),c.push("source="+encodeURIComponent(h[3])))}d="xmldb:exist://"+a.getBasePath();c.push("base="+encodeURIComponent(d));$.ajax({url:"outline",dataType:"json",type:"POST",data:c.join("&"),success:function(d){if(null!=d){for(var d=d.modules,c=0;c<d.length;c++){var g=d[c].functions;if(g)for(var h=0;h<g.length;h++)e.push({type:eXide.edit.Document.TYPE_FUNCTION,name:g[h].name,signature:g[h].signature,visibility:g[h].visibility,
source:d[c].source,sort:g[h].signature});if(g=d[c].variables)for(h=0;h<g.length;h++){var j=g[h].split(":");j.splice(1,0,":$");e.push({type:eXide.edit.Document.TYPE_VARIABLE,name:"$"+g[h],source:d[c].source,sort:j.join("")})}}a.functions=a.functions.concat(e);f.$sortFunctions(a);b&&b(a)}}});return e};Constr.prototype.initDebugger=function(a){this.xqDebugger=new eXide.XQueryDebuger(this.editor,a);this.xqDebugger.init()};Constr.prototype.stepOver=function(){this.xqDebugger&&this.xqDebugger.stepOver()};
Constr.prototype.stepInto=function(){this.xqDebugger&&this.xqDebugger.stepInto()};var g=/.*line:?\s(\d+)/i;return Constr}();eXide.namespace("eXide.edit.XMLModeHelper");
eXide.edit.XMLModeHelper=function(){Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.addCommand("closeTag",this.closeTag);this.addCommand("suggest",this.suggest)};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.closeTag=function(a,b,e){a.getBasePath();var c=this;$.ajax({type:"POST",url:"modules/validate-xml.xql",data:{xml:b,validate:"no"},dataType:"json",success:function(a){if(a.status&&"invalid"==a.status){var b=parseInt(a.message.line)-1;$.log("Message: %s",
b);b<=e&&(a=/element type \"([^\"]+)\"/.exec(a.message["#text"]),0<a.length&&c.editor.insert(a[1]+">"))}},error:function(){}})};Constr.prototype.validate=function(a,b,e){var c=this;$.ajax({type:"POST",url:"modules/validate-xml.xql",data:{xml:b},dataType:"json",success:function(d){c.compileError(d,a);e.call(this,!0)},error:function(a,b){e.call(this,!0);$.log("Compile error: %s - %s",b,a.responseText)}})};Constr.prototype.compileError=function(a,b){$.log("Validation returned %o",a);if(a.status&&"invalid"==
a.status){var e;e=a.message instanceof Array?a.message:[a.message];for(var c=[],d=0;d<e.length;d++)c.push({row:parseInt(e[d].line)-1,text:e[d]["#text"],type:"error"});this.parent.updateStatus(e[0]["#text"],b.getPath()+"#"+e[0].line);b.getSession().setAnnotations(c)}else this.parent.clearErrors(),this.parent.updateStatus("")};Constr.prototype.suggest=function(a,b,e,c){$.log("Getting suggestions for %s",b);$.ajax({type:"POST",url:"modules/validate-xml.xql",data:{xml:b,row:e,column:c},dataType:"json",
success:function(d){$this.compileError(d,a);onComplete.call(this,!0)},error:function(a,b){onComplete.call(this,!0);$.log("Compile error: %s - %s",b,a.responseText)}})};Constr.prototype.documentSaved=function(a){if(/.*\.xconf$/.test(a.getName())){var b=a.getBasePath();eXide.util.Dialog.input("Apply Configuration?","You have saved a collection configuration file. Would you like to apply it to collection "+b+" now?",function(){eXide.util.message("Apply configuration and reindex...");$.ajax({type:"POST",
url:"modules/apply-config.xql",data:{collection:a.getBasePath(),config:a.getName()},dataType:"json",success:function(a){a.error?eXide.util.error("Failed to apply configuration: "+a.error):eXide.util.success("Configuration applied.")},error:function(a){eXide.util.error("Failed to apply configuration: "+a.responseText)}})})}};return Constr}();eXide.namespace("eXide.edit.LessModeHelper");
eXide.edit.LessModeHelper=function(){var a=require("ace/token_iterator").TokenIterator;Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.addCommand("locate",this.locate)};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.documentSaved=function(a){var e=this,c=a.getText(),d="/exist/"+a.getBasePath().replace(/^\/db\//,"")+"/";(new less.Parser({paths:[d],optimization:3})).parse(c,function(d,c){d?eXide.util.error("Error: "+d.message):e.saveCSS(a,c.toCSS())})};Constr.prototype.saveCSS=
function(a,e){var c=a.getPath().replace(/\.less$/,".css");eXide.util.message("Compiling less file to "+c);$.ajax({url:"modules/store.xql",type:"POST",data:{path:c,data:e,mime:"text/css"},dataType:"json",success:function(a){"error"==a.status?eXide.util.error(a.message):eXide.util.message(c+" stored.")},error:function(a){eXide.util.error(a.responseText)}})};Constr.prototype.createOutline=function(b,e){for(var c=new a(b.getSession(),0,0),d=c.stepForward();null!=d;){if("paren.lparen"==d.type&&"{"==d.value){for(var d=
[],f=c.getCurrentTokenRow(),h=new a(b.getSession(),f,c.getCurrentTokenColumn()),g;null!=(g=h.stepBackward())&&!(h.getCurrentTokenRow()<f);)d.push(g.value);d=d.reverse().join("");b.functions.push({type:eXide.edit.Document.TYPE_FUNCTION,name:d,source:b.getPath(),signature:d,sort:d,row:c.getCurrentTokenRow(),column:c.getCurrentTokenColumn()});lastVar=""}d=c.stepForward()}e&&e(b)};return Constr}();eXide.namespace("eXide.edit.JavascriptModeHelper");
eXide.edit.JavascriptModeHelper=function(){var a=/^[\$\w\-_]+/,b=require("ace/token_iterator").TokenIterator;Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.addCommand("gotoDefinition",this.gotoDefinition);this.addCommand("locate",this.locate)};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.createOutline=function(a,c){for(var d=new b(a.getSession(),0,0),f=d.stepForward();null!=f;)"entity.name.function"==f.type&&a.functions.push({type:eXide.edit.Document.TYPE_FUNCTION,
name:f.value,signature:f.value,sort:f.value,row:d.getCurrentTokenRow(),column:d.getCurrentTokenColumn()}),f=d.stepForward();c&&c(a)};Constr.prototype.gotoDefinition=function(a){var b=this.editor.getSelection().getSelectionLead();(b=this.getFunctionAtCursor(b))&&this.locate(a,null,b)};Constr.prototype.locate=function(a,b,d){"number"==typeof d?this.editor.gotoLine(d+1):(a=this.parent.outline.findDefinition(a,d))&&a.row&&this.editor.gotoLine(a.row+1)};Constr.prototype.getFunctionAtCursor=function(b){var c=
b.row,c=this.editor.getSession().getDisplayLine(c),d=b.column;do d--;while(0<=d&&c.charAt(d).match(a));d++;for(b=b.column;b<c.length&&c.charAt(b).match(a);)b++;return c.substring(d,b)};return Constr}();eXide.namespace("eXide.edit.CssModeHelper");
eXide.edit.CssModeHelper=function(){var a=require("ace/token_iterator").TokenIterator;Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.addCommand("locate",this.locate)};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.createOutline=function(b,e){for(var c=new a(b.getSession(),0,0),d=c.stepForward(),f="";null!=d;)"variable"==d.type||"keyword"==d.type?(0<f.length&&(f+=" "),f+=d.value):"paren.rparen"==d.type?f="":"paren.lparen"==d.type&&(b.functions.push({type:eXide.edit.Document.TYPE_FUNCTION,
name:f,source:b.getPath(),signature:f,sort:f,row:c.getCurrentTokenRow(),column:c.getCurrentTokenColumn()}),f=""),d=c.stepForward();e&&e(b)};return Constr}();eXide.namespace("eXide.edit.Outline");
eXide.edit.Outline=function(){Constr=function(){this.currentDoc=null;this.templates=[];this.$loadTemplates();var a=this;$("#outline-filter").keyup(function(){a.filter(this.value)})};Constr.prototype={getTemplates:function(a){for(var a=RegExp("^"+a),b=[],e=0;e<this.templates.length;e++)this.templates[e].name.match(a)&&b.push(this.templates[e]);return b},gotoDefinition:function(a,b){$.each(a.functions,function(a,c){b==c.name&&eXide.app.locate(c.type,""==c.source?null:c.source,b)})},findDefinition:function(a,
b){for(var e=0;e<a.functions.length;e++){var c=a.functions[e];if(b==c.name)return c}return null},updateOutline:function(a){var b=this;b.currentDoc=a;a.functions=[];var e=a.getModeHelper();null!=e&&e.createOutline(a,function(){b.$outlineUpdate(a)})},clearOutline:function(){$("#outline").empty()},filter:function(a){var b=RegExp(a,"i");$("#outline li a").each(function(){var a=$(this);b.test(a.text())?a.show():a.hide()})},$outlineUpdate:function(a){this.currentDoc==a&&(eXide.app.resize(),a=d3.select("#outline").selectAll("li").data(a.functions,
function(a){return a.sort}),a.enter().append("li").attr("class",function(a){return a.type==eXide.edit.Document.TYPE_FUNCTION?"ace_support.ace_function":"ace_variable"}).append("a").style("opacity",0).attr("title",function(a){return a.signature?a.signature:null}).attr("href",function(a){return"#"+(a.source?a.source:"")}).attr("class",function(a){return(a.type==eXide.edit.Document.TYPE_FUNCTION?"t.function":"t_variable")+" "+("private"===a.visibility?"private":"public")}).text(function(a){return a.name}).on("click",
function(a){var e=this.hash.substring(1);a.row?eXide.app.locate("function",""==e?null:e,parseInt(a.row)):a.type==eXide.edit.Document.TYPE_FUNCTION?eXide.app.locate("function",""==e?null:e,a.name):eXide.app.locate("variable",""==e?null:e,a.name)}).transition().duration(800).style("opacity",1),a.exit().transition().duration(400).style("opacity",0).remove(),a.sort(function(a,e){var c;if(null==a||null==e)c=-1;else{c=a.sort;var d=e.sort;c=c.toLowerCase();d=d.toLowerCase();c=c>d?1:c==d?0:-1}return c}))},
$loadTemplates:function(){var a=this;$.ajax({url:"templates/snippets.xml",dataType:"xml",type:"GET",success:function(b){$(b).find("snippet").each(function(){var b=$(this),c=b.attr("abbrev"),d=b.find("description").text(),b=b.find("code").text();a.templates.push({TYPE:eXide.edit.Document.TYPE_TEMPLATE,name:c,help:d,template:b})})}})}};return Constr}();eXide.namespace("eXide.edit.Document");
eXide.edit.Document=function(){Constr=function(a,b,e){this.name=a;this.path=b;this.mime=null;this.syntax="xquery";this.saved=!1;this.editable=!0;this.functions=[];this.helper=null;this.history=[];this.$session=e;this.externalLink=null;this.lastChangeEvent=(new Date).getTime();a=eXide.app.getPreference("softWrap");this.$session.setUseWrapMode(0!=a);0<a?this.$session.setWrapLimitRange(a,a):0>a&&this.$session.setWrapLimitRange(null,null);this.$session.setFoldStyle("markbegin")};Constr.TYPE_FUNCTION=
"function";Constr.TYPE_VARIABLE="variable";Constr.TYPE_TEMPLATE="template";Constr.prototype.getText=function(){return this.$session.getValue()};Constr.prototype.setText=function(a){this.$session.setValue(a)};Constr.prototype.getName=function(){return this.name};Constr.prototype.getPath=function(){return this.path};Constr.prototype.setPath=function(a){this.path=a};Constr.prototype.getBasePath=function(){return this.path.replace(/(^.+)\/[^\/]*$/,"$1")};Constr.prototype.getMime=function(){return this.mime};
Constr.prototype.setMime=function(a){this.mime=a};Constr.prototype.getSyntax=function(){return this.syntax};Constr.prototype.setSyntax=function(a){this.syntax=a};Constr.prototype.getSession=function(){return this.$session};Constr.prototype.isSaved=function(){return this.saved};Constr.prototype.isNew=function(){$.log("doc name: %s",this.path);return/__new__/.test(this.path)};Constr.prototype.isEditable=function(){return this.editable};Constr.prototype.isXQuery=function(){return"application/xquery"==
this.mime};Constr.prototype.setModeHelper=function(a){this.helper=a};Constr.prototype.getModeHelper=function(){return this.helper};Constr.prototype.addToHistory=function(a){this.history.push(a)};Constr.prototype.getLastLine=function(){return this.history.pop(line)};Constr.prototype.getCurrentLine=function(){return this.$session.getSelection().getSelectionLead().row};Constr.prototype.getExternalLink=function(){return this.externalLink};return Constr}();eXide.namespace("eXide.edit.Editor");
eXide.edit.Editor=function(){var a=require("ace/virtual_renderer").VirtualRenderer,b=require("ace/editor").Editor,e=require("ace/edit_session").EditSession,c=require("ace/undomanager").UndoManager;Constr=function(d,f,e){var c=this;c.container=d;c.menubar=f;c.projects=e;c.documents=[];c.activeDoc=null;c.tabCounter=0;c.newDocCounter=0;c.pendingCheck=!1;c.themes={};c.initializing=!0;d=new a(c.container,"ace/theme/eclipse");d.setShowGutter(!0);this.editor=new b(d);this.editor.setBehavioursEnabled(!0);
this.editor.setShowFoldWidgets(!0);this.editor.setFadeFoldWidgets(!1);require("ace/multi_select").MultiSelect(this.editor);eXide.edit.commands.init(c);this.outline=new eXide.edit.Outline;this.addEventListener("activate",this.outline,this.outline.updateOutline);this.addEventListener("validate",this.outline,this.outline.updateOutline);this.addEventListener("close",this.outline,this.outline.clearOutline);this.status=document.getElementById("error-status");$(this.status).click(function(a){a.preventDefault();
var d=this.pathname,a=this.hash.substring(1);if(d=c.getDocument(d))c.switchTo(d),c.editor.gotoLine(parseInt(a)+1)});this.quicksearch=new eXide.find.IncrementalSearch($("#search-box"),this.editor);this.search=new eXide.find.SearchReplace(this.editor);var i=$("#tabs-container");i.css({overflow:"hidden"});i.mousemove(function(a){var d=i.find("ul"),b=i.width(),d=d.find("li:last-child"),d=d[0].offsetLeft+d.outerWidth(),a=(a.pageX-i.offset().left)*(d-b)/b;i.scrollLeft(a)});this.lastChangeEvent=(new Date).getTime();
this.validateTimeout=null;c.modes={xquery:new eXide.edit.XQueryModeHelper(c,f),xml:new eXide.edit.XMLModeHelper(c),html:new eXide.edit.XMLModeHelper(c),less:new eXide.edit.LessModeHelper(c),javascript:new eXide.edit.JavascriptModeHelper(c),css:new eXide.edit.CssModeHelper(c)};$("#dialog-goto-line").dialog({modal:!1,autoOpen:!1,height:200,width:300,buttons:{Goto:function(){var a=$(this).find('input[name="row"]').val(),d=$(this).find('input[name="column"]').val();d&&""!=d?c.editor.gotoLine(a,d,!0):
c.editor.gotoLine(a,0,!0);$(this).dialog("close");c.editor.focus()},Cancel:function(){$(this).dialog("close");c.editor.focus()}},open:function(){$(this).find("input[name='row']").val("");$(this).find("input[name='column']").val("");$(this).find("input:first").focus();var a=$(this);a.find("input").keyup(function(d){13==d.keyCode&&a.parent().find(".ui-dialog-buttonpane button:first").trigger("click")})}})};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.init=function(){0==this.documents.length&&
this.newDocument(null,"xquery");this.initializing=!1;var a=this.getActiveDocument();this.$triggerEvent("activate",[a])};Constr.prototype.exec=function(){if(this.activeDoc.getModeHelper()){var a=Array.prototype.slice.call(arguments,1);this.activeDoc.getModeHelper().exec(arguments[0],this.activeDoc,a)}else eXide.util.message("Not supported in this mode.")};Constr.prototype.getActiveDocument=function(){return this.activeDoc};Constr.prototype.getText=function(){return this.activeDoc.getText()};Constr.prototype.newDocument=
function(a,b){for(var c=0,g=0;g<this.documents.length;g++)this.documents[g].path.match(/^__new__(\d+)/)&&(c=parseInt(RegExp.$1));c++;g=a&&"string"==typeof a?new e(a):b&&"xquery"===b?new e('xquery version "3.0";\n'):new e("");c=new eXide.edit.Document("new-document "+c,"__new__"+c,g);b?c.setSyntax(b):c.setSyntax("text");this.$initDocument(c,!0)};Constr.prototype.newDocumentWithText=function(a,b,c){a=new eXide.edit.Document(c.name,c.path,new e(a));a.editable=c.writable;a.mime=b;a.syntax=eXide.util.mimeTypes.getLangFromMime(b);
a.saved=!1;c.line&&(a.addToHistory(c.line),this.editor.gotoLine(c.line));this.$initDocument(a)};Constr.prototype.newDocumentFromTemplate=function(a,b){if(!b||0==b.length)this.newDocument(null,a);else{var c=this;$.ajax({url:"modules/get-template.xql",type:"POST",data:{template:b},dataType:"text",success:function(b){for(var f=0,j=0;j<c.documents.length;j++)c.documents[j].path.match(/^__new__(\d+)/)&&(f=parseInt(RegExp.$1));f++;b=new e(b);f=new eXide.edit.Document("new-document "+f,"__new__"+f,b);f.setSyntax(a);
c.$initDocument(f,!0)}})}};Constr.prototype.openDocument=function(a,b,c,g){c.writable?eXide.util.message("Opening "+c.path):eXide.util.message("Opening "+c.path+" readonly!");a=new eXide.edit.Document(c.name,c.path,new e(a));a.editable=c.writable;a.mime=b;a.syntax=eXide.util.mimeTypes.getLangFromMime(b);a.externalLink=g;a.saved=!0;c.line&&(a.addToHistory(c.line),b=a.$session.getSelection(),b.clearSelection(),b.moveCursorTo(c.line,1),a.$session.setScrollTop(c.line));$.log("opening %s, mime: %s, syntax: %s, line: %i",
c.name,a.mime,a.syntax,c.line);this.$initDocument(a)};Constr.prototype.$initDocument=function(a,b){var e=this;e.$setMode(a,b);a.$session.setUndoManager(new c);a.$session.addEventListener("change",function(){a.saved&&(a.saved=!1,e.updateTabStatus(a.path,a));e.triggerCheck()});e.addTab(a);e.editor.setSession(a.$session);e.editor.resize();e.editor.focus();a.$session.getDocument().on("change",function(){e.$triggerEvent("change",[e.activeDoc])});a.getModeHelper()&&a.getModeHelper().activate()};Constr.prototype.setMode=
function(a){this.activeDoc.syntax=a;this.$setMode(this.activeDoc,!0)};Constr.prototype.$setMode=function(a,b){switch(a.getSyntax()){case "xquery":var c=require("eXide/mode/xquery").Mode;a.$session.setMode(new c(this));b&&(a.mime="application/xquery");break;case "xml":c=require("eXide/mode/xml").Mode;a.$session.setMode(new c(this));b&&(a.mime="application/xml");break;case "html":c=require("eXide/mode/html").Mode;a.$session.setMode(new c(this));b&&(a.mime="text/html");break;case "javascript":c=require("ace/mode/javascript").Mode;
a.$session.setMode(new c);b&&(a.mime="application/x-javascript");break;case "css":c=require("ace/mode/css").Mode;a.$session.setMode(new c);b&&(a.mime="text/css");break;case "text":c=require("ace/mode/text").Mode,a.$session.setMode(new c),b&&(a.mime="text/text");case "less":c=require("ace/mode/less").Mode,a.$session.setMode(new c),b&&(a.mime="application/less")}(c=this.modes[a.getSyntax()])||(c=new eXide.edit.ModeHelper(this));a.setModeHelper(c)};Constr.prototype.closeDocument=function(){this.$triggerEvent("close",
[this.activeDoc]);$('#tabs a[title="'+this.activeDoc.path+'"]').parent().remove();this.menubar.remove("buffers",this.activeDoc.path);for(var a=0;a<this.documents.length;a++)this.documents[a].path==this.activeDoc.path&&this.documents.splice(a,1);0==this.documents.length?this.newDocument(null,"xquery"):(this.activeDoc=this.documents[this.documents.length-1],$('#tabs a[title="'+this.activeDoc.path+'"]').addClass("active"),this.editor.setSession(this.activeDoc.$session),this.editor.resize(),this.$triggerEvent("activate",
[this.activeDoc]))};Constr.prototype.saveDocument=function(a,b,c){var e=this,i=e.activeDoc.path,j=e.activeDoc.name;a&&(e.activeDoc.path=a.path,e.activeDoc.name=a.name);eXide.util.message("Storing resource "+e.activeDoc.name+"...");a={path:e.activeDoc.path,data:e.activeDoc.getText()};e.activeDoc.mime&&(a.mime=e.activeDoc.mime);$.ajax({url:"modules/store.xql",type:"POST",data:a,dataType:"json",success:function(a){if(a.status=="error")c?c.apply(e.activeDoc,[a.message]):eXide.util.error(a.message);else{e.activeDoc.saved=
true;e.activeDoc.externalLink=a.externalLink;e.updateTabStatus(i,e.activeDoc);b?b.apply(e.activeDoc):eXide.util.success(e.activeDoc.name+" stored.");(a=e.activeDoc.getModeHelper())&&a.documentSaved(e.activeDoc)}},error:function(a){e.activeDoc.path=i;e.activeDoc.name=j;c?c.apply(e.activeDoc,a.responseText):eXide.util.error(a.responseText)}})};Constr.prototype.reload=function(a){this.activeDoc.getSession().setValue(a)};Constr.prototype.getDocument=function(a){for(var a=eXide.util.normalizePath(a),b=
0;b<this.documents.length;b++)if(this.documents[b].path==a)return this.documents[b]};Constr.prototype.onInput=function(a,b){var c=a.getModeHelper();if(c&&c.onInput)c.onInput(a,b)};Constr.prototype.autocomplete=function(){var a=this.activeDoc.getModeHelper();a&&a.autocomplete&&a.autocomplete(this.activeDoc)};Constr.prototype.getHeight=function(){return $(this.container).height()};Constr.prototype.resize=function(){this.editor.resize()};Constr.prototype.clearErrors=function(){this.editor.getSession().clearAnnotations()};
Constr.prototype.forEachDocument=function(a){for(var b=0;b<this.documents.length;b++)a(this.documents[b])};Constr.prototype.gotoLine=function(){$("#dialog-goto-line").dialog("open");$("#dialog-goto-line input[type='text']").val("");$('#dialog-goto-line input[name="row"]').focus()};Constr.prototype.addTab=function(a){var b=this,c="t"+b.tabCounter++,e=a.name;a.saved||(e+="*");$("#tabs li a").removeClass("active");var i=document.createElement("li"),j=document.createElement("a");j.appendChild(document.createTextNode(e));
j.className="tab active";j.id=c;j.title=a.path;i.appendChild(j);$("#tabs").append(i);$(j).click(function(c){c.preventDefault();b.switchTo(a)});b.menubar.add("buffers",e,j.title,function(){b.switchTo(a)});b.activeDoc=a;b.documents.push(a);b.initializing||b.$triggerEvent("activate",[a]);b.scrollToTab($(j))};Constr.prototype.switchTo=function(a){var b=this.activeDoc.getModeHelper();b&&b.deactivate();this.editor.setSession(a.$session);this.editor.resize();this.activeDoc=a;var c=this;$("#tabs a").each(function(){var b=
$(this);this.title==a.path?(b.addClass("active"),c.scrollToTab(b)):b.removeClass("active")});this.updateStatus("");this.$triggerEvent("activate",[a]);(b=a.getModeHelper())&&b.activate()};Constr.prototype.updateTabStatus=function(a,b){var c;c=b.saved?b.name:b.name+"*";$('#tabs a[title="'+a+'"]').attr("title",b.path).text(c)};Constr.prototype.scrollToTab=function(a){var b=a.offset().left,a=b+a.outerWidth(),c=$("#tabs-container").innerWidth(),e=$("#tabs-container").scrollLeft();a>c?$("#tabs-container").scrollLeft(a-
c):b<e&&(b<c?$("#tabs-container").scrollLeft(0):$("#tabs-container").scrollLeft(b));$.log("Scrolling to %d %d",b,$("#tabs-container").scrollLeft())};Constr.prototype.setTheme=function(a){$.log("Changing theme to %s",a);var b=this;b.loadTheme(a,function(){b.editor.setTheme("ace/theme/"+a);b.$triggerEvent("setTheme",[require(b.editor.getTheme())])})};Constr.prototype.loadTheme=function(a,b){if(this.themes[a])return b();require("ace/lib/net");this.themes[a]=1;var c="$shared/resources/scripts/ace/theme-"+
a.split("/").pop()+".js",e=document.getElementsByTagName("head")[0],i=document.createElement("script");i.src=c;e.appendChild(i);i.onload=b};Constr.prototype.updateStatus=function(a,b){this.status.innerHTML=a;b&&(this.status.href=b)};Constr.prototype.triggerCheck=function(){if(this.activeDoc.getModeHelper()){var a=this;if(!a.pendingCheck){var b=(new Date).getTime();a.validateTimeout&&1E3>b-this.activeDoc.lastChangeEvent&&clearTimeout(a.validateTimeout);this.activeDoc.lastChangeEvent=b;this.validateTimeout=
setTimeout(function(){a.validate.apply(a)},1E3)}}};Constr.prototype.validate=function(){var a=this;a.$triggerEvent("validate",[a.activeDoc]);var b=a.activeDoc.getModeHelper();b&&b.validate&&(a.pendingCheck=!0,$.log("Running validation..."),b.validate(a.activeDoc,a.getText(),function(){a.pendingCheck=!1}))};Constr.prototype.evalError=function(a){var b=/.*line\s(\d+)/i.exec(a),c=-1;b&&(c=parseInt(b[1]));$.log("error in line %d",b[1]);this.editor.focus();this.editor.gotoLine(c);b=[{row:c-1,text:a,type:"error"}];
this.updateStatus(a);this.editor.getSession().setAnnotations(b)};Constr.prototype.focus=function(){this.editor.focus()};Constr.prototype.saveState=function(){var a=0;$.each(this.documents,function(b,c){if(c.path.match("^__new__.*")){var e=c.getText();e&&0<e.length&&(localStorage["eXide."+a+".path"]=c.path,localStorage["eXide."+a+".name"]=c.name,localStorage["eXide."+a+".mime"]=c.mime,localStorage["eXide."+a+".data"]=c.getText(),localStorage["eXide."+a+".last-line"]=c.getCurrentLine())}else localStorage["eXide."+
a+".path"]=c.path,localStorage["eXide."+a+".name"]=c.name,localStorage["eXide."+a+".mime"]=c.mime,localStorage["eXide."+a+".writable"]=c.editable?"true":"false",localStorage["eXide."+a+".last-line"]=c.getCurrentLine(),c.saved||(localStorage["eXide."+a+".data"]=c.getText());a++});localStorage["eXide.documents"]=a};return Constr}();$(document).ready(function(){window.name="eXide";var a;var b=window.location.search.substr(1).split("&");if(""==b)a={};else{for(var e={},c=0;c<b.length;++c){var d=b[c].split("=");2==d.length&&(e[d[0]]=decodeURIComponent(d[1].replace(/\+/g," ")))}a=e}eXide.app.init(function(b){var c=a.open,d=a.snip;c&&!b[c]?eXide.app.findDocument(a.open):d&&eXide.app.newDocument(d,"xquery");window.opener&&window.opener.eXide_onload&&window.opener.eXide_onload(eXide.app)})});eXide.namespace("eXide.app");
eXide.app=function(){var a,b,e,c,d,f={},h,g=0,i=0,j=0,l=0,m=!0;return{init:function(f){h=new eXide.util.Menubar($(".menu"));c=new eXide.edit.Projects;a=new eXide.edit.Editor(document.getElementById("editor"),h);b=new eXide.edit.PackageEditor(c);e=new eXide.browse.Browser(document.getElementById("open-dialog"));b.addEventListener("change",null,function(a){e.changeToCollection(a);eXide.app.openDocument()});d=new eXide.util.Preferences(a);a.addEventListener("setTheme",eXide.app.setTheme);eXide.app.initGUI(h);
eXide.app.getLogin(function(){eXide.app.initStatus("Restoring state");eXide.app.restoreState(function(b){a.init();f&&f(b);$("body").layout().toggle("south");$("#splash").fadeOut(400)})});a.addEventListener("outlineChange",eXide.app.onOutlineChange);$(window).resize(eXide.app.resize);$(window).unload(function(){eXide.app.saveState()});eXide.find.Modules.addEventListener("open",null,function(a){eXide.app.findDocument(a.at)});eXide.find.Modules.addEventListener("import",null,function(b){a.exec("importModule",
b.prefix,b.uri,b.at)})},hasFocus:function(){return m},resize:function(){$("#editor");$(".header");a.resize()},newDocument:function(b,c){a.newDocument(b,c)},newDocumentFromTemplate:function(){$("#dialog-templates").dialog("open")},findDocument:function(b){var c=a.getDocument(b);null==c?(b={name:b.match(/[^\/]+$/)[0],path:b},eXide.app.$doOpenDocument(b)):a.switchTo(c)},locate:function(b,c,d){if(null==c)a.exec("locate",b,d);else{var f=a.getDocument(c);null==f?(c={name:c.match(/[^\/]+$/)[0],path:c},eXide.app.$doOpenDocument(c,
function(c){c&&a.exec("locate",b,d)})):(a.switchTo(f),a.exec("locate",b,d))}},openDocument:function(){e.reload(["reload"],"open");$("#open-dialog").dialog("option","title","Open Document");$("#open-dialog").dialog("option","buttons",{cancel:function(){$(this).dialog("close");a.focus()},open:eXide.app.openSelectedDocument});$("#open-dialog").dialog("open")},openSelectedDocument:function(a){var b=e.getSelection();b&&eXide.app.$doOpenDocument(b);(void 0==a||a)&&$("#open-dialog").dialog("close")},$doOpenDocument:function(b,
c,d){b.path=eXide.util.normalizePath(b.path);var f=a.getDocument(b.path);if(f&&!d)return a.switchTo(f),c&&c(b),!0;$.ajax({url:"modules/load.xql?path="+b.path,dataType:"text",success:function(f,e,g){d?a.reload(f):(e=eXide.util.mimeTypes.getMime(g.getResponseHeader("Content-Type")),g=g.getResponseHeader("X-Link"),a.openDocument(f,e,b,g));c&&c(b);return!0},error:function(a){eXide.util.error("Failed to load document "+b.path+": "+a.status+" "+a.statusText);c&&c(null);return!1}})},reloadDocument:function(){var b=
a.getActiveDocument();b.isSaved()?eXide.app.$reloadDocument(b):eXide.util.Dialog.input("Reload Document","Do you really want to reload the document?",function(){eXide.app.$reloadDocument(b)})},$reloadDocument:function(a){a={name:a.getName(),path:a.getPath()};eXide.app.$doOpenDocument(a,null,!0)},closeDocument:function(){a.getActiveDocument().isSaved()?a.closeDocument():$("#dialog-confirm-close").dialog({resizable:!1,height:140,modal:!0,buttons:{Close:function(){$(this).dialog("close");a.closeDocument()},
Cancel:function(){$(this).dialog("close")}},open:function(){$(this).closest(".ui-dialog").find(".ui-dialog-buttonpane button:eq(0)").focus();$(this).closest(".ui-dialog").find(".ui-dialog-buttonpane button:eq(1)").blur()}})},saveDocument:function(){eXide.app.requireLogin(function(){a.getActiveDocument().getPath().match("^__new__")?(e.reload(["reload","create"],"save"),$("#open-dialog").dialog("option","title","Save Document"),$("#open-dialog").dialog("option","buttons",{Cancel:function(){$(this).dialog("close")},
Save:function(){a.saveDocument(e.getSelection(),function(){$("#open-dialog").dialog("close");b.autoSync(a.getActiveDocument().getBasePath());eXide.app.updateStatus(this)},function(a){eXide.util.Dialog.warning("Failed to Save Document",a)})}}),$("#open-dialog").dialog("open")):a.saveDocument(null,function(){eXide.util.message(a.getActiveDocument().getName()+" stored.");b.autoSync(a.getActiveDocument().getBasePath())},function(a){eXide.util.Dialog.warning("Failed to Save Document",a)})})},saveDocumentAs:function(){eXide.app.requireLogin(function(){e.reload(["reload",
"create"],"save");$("#open-dialog").dialog("option","title","Save Document As ...");$("#open-dialog").dialog("option","buttons",{Cancel:function(){$(this).dialog("close")},Save:function(){a.saveDocument(e.getSelection(),function(){$("#open-dialog").dialog("close");b.autoSync(a.getActiveDocument().getBasePath());eXide.app.updateStatus(this)},function(a){eXide.util.Dialog.warning("Failed to Save Document",a)})}});$("#open-dialog").dialog("open")})},exec:function(){a.exec(arguments)},download:function(){var b=
a.getActiveDocument();b.getPath().match("^__new__")||!b.isSaved()?eXide.util.error("There are unsaved changes in the document. Please save it first."):window.location.href="modules/load.xql?download=true&path="+encodeURIComponent(b.getPath())},runQuery:function(){a.updateStatus("Running query ...");var b=a.getText(),c="xmldb:exist://"+a.getActiveDocument().getBasePath();$("#results-container .results").empty();$.ajax({type:"POST",url:"execute",dataType:"xml",data:{qu:b,base:c},success:function(b){b=
b.documentElement;"error"==b.nodeName?(b=$(b).text(),eXide.util.error(b,"Compilation Error"),a.evalError(b)):(a.updateStatus(""),a.clearErrors(),$("body").layout().open("south"),eXide.app.resize(),j=i=1,g=b.getAttribute("hits"),l=i+10-1,g<l&&(l=g),eXide.util.message("Found "+g+" in "+b.getAttribute("elapsed")+"s"),eXide.app.retrieveNext())},error:function(a){eXide.util.error(a.responseText,"Server Error")}})},checkQuery:function(){a.validate()},retrieveNext:function(){$.log("retrieveNext: %d",j);
if(0<j&&j<=l){var a="results/"+j;j++;$.ajax({url:a,dataType:"html",success:function(a){$("#results-container .results").append(a);$("#results-container .current").text("Showing results "+i+" to "+(j-1)+" of "+g);$("#results-container .pos:last a").click(function(){eXide.app.findDocument($(this).data("path"));return!1});eXide.app.retrieveNext()}})}},browseNext:function(){0<j&&l<g&&(i=j,l=j+10-1,g<l&&(l=g),$("#results-container .results").empty(),eXide.app.retrieveNext());return!1},browsePrevious:function(){0<
j&&1<i&&(i-=10,1>i&&(i=1),j=i,l=j+9,g<l&&(l=g),$("#results-container .results").empty(),eXide.app.retrieveNext());return!1},manage:function(){eXide.app.requireLogin(function(){e.reload("reload create upload properties open cut copy paste".split(" "),"manage");$("#open-dialog").dialog("option","title","DB Manager");$("#open-dialog").dialog("option","buttons",{Close:function(){$(this).dialog("close")}});$("#open-dialog").dialog("open")})},deploymentSettings:function(){var c=a.getActiveDocument().getPath(),
d=/^(.*)\/[^\/]+$/.exec(c);d&&eXide.app.requireLogin(function(){$.log("Editing deployment settings for collection: %s",d[1]);b.open(d[1])})},newDeployment:function(){eXide.app.requireLogin(function(){b.open()})},deploy:function(){eXide.app.requireLogin(function(){var c=a.getActiveDocument().getPath(),c=/^(.*)\/[^\/]+$/.exec(c);if(!c)return eXide.util.error("The file open in the editor does not belong to an application package!"),!1;$.log("Deploying application from collection: %s",c[1]);b.deploy(c[1])});
return!1},synchronize:function(){eXide.app.requireLogin(function(){var c=a.getActiveDocument().getPath();(c=/^(.*)\/[^\/]+$/.exec(c))?b.synchronize(c[1]):eXide.util.error("The file open in the editor does not belong to an application package!")})},downloadApp:function(){eXide.app.requireLogin(function(){var c=a.getActiveDocument().getPath(),c=/^(.*)\/[^\/]+$/.exec(c);$.log("downloading %s",c);c?b.download(c[1]):eXide.util.error("The file open in the editor does not belong to an application package!")})},
openApp:function(){var c=a.getActiveDocument().getPath();(c=/^(.*)\/[^\/]+$/.exec(c))?b.runApp(c[1]):eXide.util.error("The file open in the editor does not belong to an application package!")},restoreState:function(c){if(!eXide.util.supportsHtml5Storage)return!1;d.read();var f={},e=localStorage["eXide.documents"];e||(e=0);for(var g=[],h=0;h<e;h++){var i={path:localStorage["eXide."+h+".path"],name:localStorage["eXide."+h+".name"],writable:"true"==localStorage["eXide."+h+".writable"],line:parseInt(localStorage["eXide."+
h+".last-line"])};if(i.name){$.log("Restoring doc %s, going to line = %i",i.path,i.line);var j=localStorage["eXide."+h+".data"];j?a.newDocumentWithText(j,localStorage["eXide."+h+".mime"],i):g.push(i);f[i.path]=i}}this.restoreDocs(g,function(){a.getActiveDocument()||eXide.app.newDocument("","xquery");c&&c(f)});b.restoreState();return f},restoreDocs:function(a,b){if(0==a.length)b();else{var c=this,d=a.pop();eXide.app.$doOpenDocument(d,function(){c.restoreDocs(a,b)})}},saveState:function(){eXide.util.supportsHtml5Storage&&
(localStorage.clear(),d.save(),a.saveState(),b.saveState())},getLogin:function(a){$.ajax({url:"login",dataType:"json",success:function(b){eXide.app.login=b;$("#user").text("Logged in as "+eXide.app.login.user+". ");a&&a()},error:function(){eXide.app.login=null;$("#user").text("Login");a&&a()}})},$checkLogin:function(){if(eXide.app.login)return!0;eXide.util.error("Warning: you are not logged in.");return!1},requireLogin:function(a){eXide.app.login?a():($("#login-dialog").dialog("option","close",function(){eXide.app.login?
a():eXide.util.error("Warning: you are not logged in!")}),$("#login-dialog").dialog("open"))},showPreferences:function(){d.show()},getPreference:function(a){return d.get(a)},startDebug:function(){var b=$("#debug span.ui-icon");b.hasClass("ui-icon-stop")?(b.removeClass("ui-icon-stop"),b.addClass("ui-icon-play")):(b.removeClass("ui-icon-play"),b.addClass("ui-icon-stop"));a.exec("debug");$.log("start debugging click")},stepOver:function(){a.exec("stepOver")},stepInto:function(){a.exec("stepInto")},setTheme:function(a){$("#outline-body").removeClass().addClass(a.cssClass);
$("#results-body").removeClass().addClass(a.cssClass)},updateStatus:function(a){$("#syntax").val(a.getSyntax());$("#status span").text(eXide.util.normalizePath(a.getPath()));!a.isNew()&&("xquery"==a.getSyntax()||"html"==a.getSyntax()||"xml"==a.getSyntax())?($("#status a").attr("href",a.getExternalLink()),$("#status a").css("visibility","visible")):$("#status a").css("visibility","hidden")},initStatus:function(a){$("#splash-status").text(a)},initGUI:function(b){$("body").layout({enableCursorHotkey:!1,
spacing_open:6,spacing_closed:8,north__size:70,north__resizable:!1,north__closable:!1,north__showOverflowOnHover:!0,north__spacing_open:0,south__minSize:200,south__size:300,south__initClosed:!1,south__contentSelector:"#results-body",west__size:200,west__initClosed:!1,west__contentSelector:".content",east__initClosed:!0,center__minSize:300,center__onresize:eXide.app.resize,center__contentSelector:".content"});$("#open-dialog").dialog({title:"Open file",modal:!1,autoOpen:!1,height:480,width:600,open:function(){e.init()},
resize:function(){e.resize()}});$("#login-dialog").dialog({title:"Login",modal:!0,autoOpen:!1,buttons:{Login:function(){var b=$('#login-form input[name="user"]').val(),c=$('#login-form input[name="password"]').val(),b={user:b,password:c};$('#login-form input[name="duration"]').is(":checked")&&(b.duration="P14D");$.ajax({url:"login",data:b,dataType:"json",success:function(b){eXide.app.login=b;$.log("Logged in as %s. Is dba: %s",eXide.app.login.user,eXide.app.login.isAdmin);$("#login-dialog").dialog("close");
$("#user").text("Logged in as "+eXide.app.login.user+". ");a.focus()},error:function(a,b,c){$("#login-error").text("Login failed. "+c);$("#login-dialog input:first").focus()}})},Cancel:function(){$(this).dialog("close");a.focus()}},open:function(){$(this).find("input").val("");$(this).find("input:first").focus();$("#login-error").empty();var a=$(this);a.find("input").keyup(function(b){13==b.keyCode&&a.parent().find(".ui-dialog-buttonpane button:first").trigger("click")})}});$("#keyboard-help").dialog({title:"Keyboard Shortcuts",
modal:!1,autoOpen:!1,height:400,buttons:{Close:function(){$(this).dialog("close")}},open:function(){eXide.edit.commands.help($("#keyboard-help"),a)}});$("#about-dialog").dialog({title:"About",modal:!1,autoOpen:!1,height:300,width:450,buttons:{Close:function(){$(this).dialog("close")}}});$("#dialog-templates").dialog({title:"New document",modal:!1,autoOpen:!1,height:280,width:550,dataType:"json",open:function(){$.ajax({url:"modules/get-template.xql",type:"POST",success:function(a){f=a;$("#dialog-templates .templates").hide();
$("#dialog-templates .type-select").val("")}})},buttons:{Cancel:function(){$(this).dialog("close");a.focus()},Create:function(){var b=$(this).find(".type-select").val(),c=$(this).find(".templates select").val();$.log("creating new doc with mode: %s and template: %s",b,c);a.newDocumentFromTemplate(b,c);$(this).dialog("close");a.focus()}}});$("#dialog-templates .type-select").change(function(){var a=$("#dialog-templates .templates"),b=$("select",a),c=$(this).val();b.empty();if(c=f[c]){for(var d="<option value=''>None</option>",
e=0;e<c.length;e++)d+="<option value='"+c[e].name+"'>"+c[e].description+"</option>";b.html(d);a.show()}else a.hide()});var g=$("#open").button({icons:{primary:"ui-icon-folder-open"}});g.click(eXide.app.openDocument);b.click("#menu-file-open",eXide.app.openDocument,"openDocument");g=$("#close").button({icons:{primary:"ui-icon-close"}});g.click(eXide.app.closeDocument);b.click("#menu-file-close",eXide.app.closeDocument,"closeDocument");g=$("#new").button({icons:{primary:"ui-icon-document"}});g.click(function(){eXide.app.newDocumentFromTemplate()});
g=$("#new-xquery").button({icons:{primary:"ui-icon-document"}});g.click(function(){eXide.app.newDocument(null,"xquery")});b.click("#menu-file-new",eXide.app.newDocumentFromTemplate,"newDocumentFromTemplate");b.click("#menu-file-new-xquery",function(){eXide.app.newDocument(null,"xquery")},"newXQuery");g=$("#run").button({icons:{primary:"ui-icon-play"}});g.click(eXide.app.runQuery);g=$("#debug").button({icons:{primary:"ui-icon-seek-end"}});g.click(eXide.app.startDebug);g=$("#debug-actions #step-over").button({icons:{primary:"ui-icon-seek-end"}});
g.click(eXide.app.stepOver);g=$("#debug-actions #step-into").button({icons:{primary:"ui-icon-seek-end"}});g.click(eXide.app.stepInto);g=$("#debug-actions #step-out").button({icons:{primary:"ui-icon-seek-end"}});g.click(eXide.app.startDebug);g=$("#validate").button({icons:{primary:"ui-icon-check"}});g.click(eXide.app.checkQuery);g=$("#save").button({icons:{primary:"ui-icon-disk"}});g.click(eXide.app.saveDocument);b.click("#menu-file-save",eXide.app.saveDocument,"saveDocument");b.click("#menu-file-save-as",
eXide.app.saveDocumentAs);b.click("#menu-file-reload",eXide.app.reloadDocument);g=$("#download").button({icons:{primary:"ui-icon-transferthick-e-w"}});g.click(eXide.app.download);b.click("#menu-file-download",eXide.app.download);b.click("#menu-file-manager",eXide.app.manage,"dbManager");b.click("#menu-deploy-new",eXide.app.newDeployment);b.click("#menu-deploy-edit",eXide.app.deploymentSettings);b.click("#menu-deploy-deploy",eXide.app.deploy);b.click("#menu-deploy-sync",eXide.app.synchronize,"synchronize");
b.click("#menu-deploy-download",eXide.app.downloadApp);b.click("#menu-edit-undo",function(){a.editor.undo()},"undo");b.click("#menu-edit-redo",function(){a.editor.redo()},"redo");b.click("#menu-edit-find",function(){a.quicksearch.start()},"searchIncremental");b.click("#menu-edit-toggle-comment",function(){a.editor.toggleCommentLines()},"toggleComment");b.click("#menu-edit-preferences",function(){d.show()},"preferences");b.click("#menu-navigate-definition",function(){a.exec("gotoDefinition")},"gotoDefinition");
b.click("#menu-navigate-modules",function(){var b=a.getActiveDocument();eXide.find.Modules.select(b.syntax)},"findModule");b.click("#menu-navigate-info",function(){a.exec("showFunctionDoc")},"functionDoc");b.click("#menu-deploy-run",eXide.app.openApp,"openApp");b.click("#menu-help-keyboard",function(){$("#keyboard-help").dialog("open")});b.click("#menu-help-about",function(){$("#about-dialog").dialog("open")});b.click("#menu-help-hints",function(){eXide.util.Help.show()});$("#syntax").change(function(){a.setMode($(this).val())});
a.addEventListener("activate",null,function(a){eXide.app.updateStatus(a);c.findProject(a.getBasePath(),function(a){a?($("#toolbar-current-app").text(a.abbrev),$("#menu-deploy-active").text(a.abbrev)):($("#toolbar-current-app").text("unknown"),$("#menu-deploy-active").text("unknown"))})});$("#user").click(function(a){a.preventDefault();eXide.app.login?($.get("login?logout=logout"),$("#user").text("Login"),eXide.app.login=null):$("#login-dialog").dialog("open")});$("#results-container .next").click(eXide.app.browseNext);
$("#results-container .previous").click(eXide.app.browsePrevious);$("#error-status").mouseover(function(){var a=this;$("#ext-status-bar").each(function(){this.innerHTML=a.innerHTML;$(this).css("display","block")})});$("#ext-status-bar").mouseout(function(){$(this).css("display","none")});$(window).blur(function(){m=!1});$(window).focus(function(){var a=!m;m=!0;a&&eXide.app.getLogin()})}}}();eXide.namespace("eXide.edit.Projects");
eXide.edit.Projects=function(){Constr=function(){this.projects={}};Constr.prototype.findProject=function(a,b){var e=this.getProjectFor(a);e?b(e):this.getProject(a,b)};Constr.prototype.getProject=function(a,b){var e=this;$.getJSON("modules/deployment.xql",{info:a},function(a){if(a){var d=e.projects[a.abbrev];d?eXide.util.oop.extend(d,a):(d=a,e.projects[a.abbrev]=d);"function"==typeof b&&b(d)}else"function"==typeof b&&b(null)})};Constr.prototype.getProjectFor=function(a){for(k in this.projects){var b=
this.projects[k];if(a.substring(0,b.root.length)===b.root)return b}return null};Constr.prototype.saveState=function(){localStorage["eXide.projects"]=JSON.stringify(this.projects)};Constr.prototype.restoreState=function(){localStorage["eXide.projects"]&&(this.projects=JSON.parse(localStorage["eXide.projects"]),"object"!=typeof this.projects&&(this.projects={}))};return Constr}();eXide.namespace("eXide.edit.PackageEditor");
eXide.edit.PackageEditor=function(){Constr=function(a){var b=this;this.projects=a;this.currentProject=null;this.container=$("#dialog-deploy");this.container.dialog({title:"Deployment Editor",modal:!1,autoOpen:!1,width:520,height:600});this.syncDialog=$("#synchronize-dialog");this.syncDialog.dialog({title:"Synchronize to Directory",modal:!1,autoOpen:!1,width:500,height:400,buttons:{Apply:function(){var a=b.syncDialog.find('input[name="dir"]').val();a&&0<a.length&&(b.currentProject.dir=a);b.currentProject.autoSync=
b.syncDialog.find('input[name="auto"]').is(":checked");$(this).dialog("close")},Synchronize:function(){var a=b.syncDialog.find('input[name="dir"]').val();!a||0==a.length?$("#synchronize-report").text("No output directory specified!"):(b.currentProject.dir=a,a=b.syncDialog.find("form").serialize(),$("#synchronize-report").text("Synchronization in progress ..."),$("#synchronize-report").load("modules/synchronize.xql",a))},Close:function(){$(this).dialog("close")}}})};eXide.util.oop.inherit(Constr,eXide.events.Sender);
Constr.prototype.open=function(a){var b=this,e=null;a&&(e={collection:a});$.ajax({url:"modules/deployment.xql",type:"POST",data:e,success:function(a){b.container.html(a);b.container.form({done:function(){var a=b.container.find("form").serialize();$.ajax({url:"modules/deployment.xql",type:"POST",dataType:"json",data:a,success:function(a){b.container.dialog("close");b.$triggerEvent("change",[a])},error:function(a){eXide.util.error(a.responseText)}})},cancel:function(){b.container.dialog("close")}});
b.container.find(".author-repeat").repeat("#author-add-trigger",{deleteTrigger:"#author-remove-trigger"});b.container.dialog("open")},error:function(a){eXide.util.error(a.responseText)}})};Constr.prototype.deploy=function(a){var b=this;eXide.util.Dialog.input("Deploy",'<p>Note: target has to be different from the source package or it will be overwritten!</p><p><label for="target">Target collection:</label><input id="deployment-target" type="text" name="target" value="'+a+'-test"size="30"/></p>',function(){var e=
$("#deployment-target").val();""===e&&(e=a);$.ajax({url:"modules/deployment.xql",type:"POST",dataType:"json",data:{collection:a,target:e,deploy:"true"},success:function(c){c=location.protocol+"//"+location.hostname+":"+location.port+"/exist/apps/"+c+"/";eXide.util.Dialog.message("Application Deployed",'<p>The application has been deployed. On a standard installation the following link should open it:</p><center><a href="'+c+'" target="_new">'+c+"</a></center>");b.$triggerEvent("change",a)},error:function(a){404==
a.status?eXide.util.error("Deployment failed. The document currently opened in the editor should belong to an application package."):eXide.util.Dialog.warning("Deployment Error","<p>An error has been reported by the database:</p><p>"+a.responseText+"</p>")}})})};Constr.prototype.download=function(a){window.location.href="modules/deployment.xql?download=true&collection="+encodeURIComponent(a)};Constr.prototype.synchronize=function(a){var b=this;b.projects.findProject(a,function(a){a?eXide.app.login.isAdmin?
($("#synchronize-report").empty(),b.currentProject=a,b.syncDialog.find(".project-name").text(a.abbrev),b.syncDialog.find('input[name="start"]').val(a.deployed),a.dir?b.syncDialog.find('input[name="dir"]').val(a.dir):b.syncDialog.find('input[name="dir"]').val(""),b.syncDialog.find('input[name="collection"]').val(a.root),b.syncDialog.find('input[name="auto"]').attr("checked",a.autoSync),b.syncDialog.dialog("open")):eXide.util.error("You need to be logged in as an admin user with dba role to use this feature."):
eXide.util.error("Application not found: The document currently opened in the editor should belong to an application package.")})};Constr.prototype.autoSync=function(a){(a=this.projects.getProjectFor(a))&&a.autoSync&&$.ajax({url:"modules/synchronize.xql",type:"GET",data:{collection:a.root,start:a.deployed,dir:a.dir},success:function(){eXide.util.message("Synchronized directory")}})};Constr.prototype.runApp=function(a){this.projects.findProject(a,function(a){if(a){var e="/exist"+a.url.replace(/\/{2,}/,
"/")+"/";eXide.util.Dialog.message("Run Application "+a.abbrev,'<p>Click on the following link to open your application:</p><center><a href="'+e+'" target="_new">'+e+"</a></center>")}else eXide.util.error("Application not found: The document currently opened in the editor should belong to an application package.")})};Constr.prototype.saveState=function(){this.projects.saveState()};Constr.prototype.restoreState=function(){this.projects.restoreState()};return Constr}();eXide.namespace("eXide.edit.Template");
eXide.edit.Template=function(){var a=/\n/;Constr=function(b,e,c,d){var f=c.split(a).length;this.code=c;this.editor=b.editor;this.range=e;this.type=d;this.startLine=e.start.row;this.endLine=this.startLine+f-1;$.log("startLine = %i, endLine = %i",this.startLine,this.endLine);this.currentLine=this.startLine;this.lineOffset=this.startColumn=e.start.column;this.regex=/(?:\$[\w\-:_]+|\u2423)/g;0<this.startColumn&&(this.regex.lastIndex=this.startColumn)};Constr.prototype={insert:function(){this.editor.getSession().remove(this.range);
this.editor.insert(this.code);var a=this.editor.getSelection().getSelectionLead();"$"!=this.code.substring(0,1)&&0<a.column&&this.editor.navigateLeft();"variable"!=this.type&&this.nextParam();this.editor.focus()},nextParam:function(){var a=this.editor.getSession(),e=this.editor.getSelection(),c=e.getSelectionLead();$.log("lead.row = %i startLine = %i",c.row,this.startLine);if(c.row<this.startLine||c.row>this.endLine)return!1;for(var d=c=!1;this.currentLine<=this.endLine;){var f=a.getDisplayLine(this.currentLine);
$.log("Checking line %s",f);if(f=this.regex.exec(f)){$.log("Matched %s",f[0]);e.setSelectionAnchor(this.currentLine,f.index);e.selectTo(this.currentLine,f.index+f[0].length);1===f[0].length&&a.remove(e.getRange());this.lineOffset=f.index;d=!0;break}else this.lineOffset=0,this.currentLine++;this.currentLine>this.endLine&&!c&&($.log("loop %i",this.startColumn),this.currentLine=this.startLine,0<this.startColumn&&(this.lineOffset=this.startColumn,this.regex.lastIndex=this.lineOffset),c=!0)}return d}};
return Constr}();eXide.namespace("eXide.util.Help");
eXide.util.Help=function(){var a=null,b=-1;$(document).ready(function(){$(document.body).append('<div id="eXide-dialog-help">\t<div class="help" id="eXide-dialog-help-body"></div></div>');helpDialog=$("#eXide-dialog-help");helpDialog.dialog({modal:!1,title:"Quick Start",autoOpen:!1,width:600,height:400,buttons:{OK:function(){$(this).dialog("close")},Next:function(){eXide.util.Help.next()},Previous:function(){eXide.util.Help.previous()}}});eXide.util.Help.showFirstTime()});return{show:function(){helpDialog.dialog("open");
a?eXide.util.Help.next():eXide.util.Help.load()},next:function(){b+1<a.length&&(b++,$("#eXide-dialog-help-body").html(a[b]))},previous:function(){0<b&&(b--,$("#eXide-dialog-help-body").html(a[b]))},showFirstTime:function(){if(eXide.util.supportsHtml5Storage){var a=localStorage.getItem("eXide.hints");(!a||1==a)&&eXide.util.Help.show()}},load:function(){$.ajax({url:"help.html",type:"GET",success:function(b){a=$("section",b);eXide.util.Help.show()},error:function(a){404==a.status?eXide.util.error("Failed to open help texts."):
eXide.util.Dialog.warning("Deployment Error","<p>An error has been reported by the database:</p><p>"+a.responseText+"</p>");helpDialog.dialog("close")}})}}}();eXide.namespace("eXide.util.Preferences");
eXide.util.Preferences=function(){var a={theme:"tomorrow",fontSize:14,showInvisibles:!1,showPrintMargin:!0,showHScroll:!1,softWrap:-1};Constr=function(b){this.editor=b;this.preferences=$.extend({},a);var e=this,c=$("#preferences-dialog");$("select, input",c).change(function(){e.updatePreferences()});$("#preferences-dialog").dialog({title:"Preferences",modal:!1,autoOpen:!1,height:400,width:600,buttons:{Close:function(){$(this).dialog("close");b.focus()},"Reset Defaults":function(){e.preferences=$.extend({},
a);e.updateForm()}}})};Constr.prototype.show=function(){this.updateForm();$("#preferences-dialog").dialog("open")};Constr.prototype.updateForm=function(){$.log("Updating form %s",this.preferences.fontSize);var a=$("#preferences-dialog form");$('select[name="theme"]',a).val(this.preferences.theme);$('select[name="font-size"]',a).val(this.preferences.fontSize);$('input[name="show-invisibles"]',a).attr("checked",this.preferences.showInvisibles);$('input[name="print-margin"]',a).attr("checked",this.preferences.showPrintMargin);
var e=this.preferences.softWrap;0===e?e="off":-1===e&&(e="free");$('input[name="soft-wrap"]',a).val(e)};Constr.prototype.updatePreferences=function(){var a=$("#preferences-dialog form");this.preferences.theme=$('select[name="theme"]',a).val();this.preferences.fontSize=parseInt($('select[name="font-size"]',a).val());this.preferences.showInvisibles=$('input[name="show-invisibles"]',a).is(":checked");this.preferences.showPrintMargin=$('input[name="print-margin"]',a).is(":checked");a=$('select[name="soft-wrap"]',
a).val();"free"===a?a=-1:"off"===a&&(a=0);this.preferences.softWrap=parseInt(a,10);this.applyPreferences()};Constr.prototype.applyPreferences=function(){var a=this;this.editor.setTheme(this.preferences.theme);this.editor.editor.setShowInvisibles(this.preferences.showInvisibles);this.editor.editor.setShowPrintMargin(this.preferences.showPrintMargin);this.editor.forEachDocument(function(e){0<a.preferences.softWrap?e.getSession().setWrapLimitRange(a.preferences.softWrap,a.preferences.softWrap):0>a.preferences.softWrap&&
e.getSession().setWrapLimitRange(null,null);e.getSession().setUseWrapMode(0!=a.preferences.softWrap)});this.editor.editor.setFontSize(this.preferences.fontSize+"px");this.editor.resize()};Constr.prototype.get=function(a){return this.preferences[a]};Constr.prototype.read=function(){localStorage["eXide.preferences"]&&(this.preferences=JSON.parse(localStorage.getItem("eXide.preferences")));this.applyPreferences()};Constr.prototype.save=function(){localStorage.setItem("eXide.preferences",JSON.stringify(this.preferences));
localStorage.setItem("eXide.hints",0)};return Constr}();eXide.namespace("eXide.browse.ResourceBrowser");
eXide.browse.ResourceBrowser=function(){var a=[{id:"name",name:"Name",field:"name",width:180,formatter:function(a,b,f,e,g){return g.isCollection?'<span class="collection"><img src="resources/images/folder.png"/> '+f+"</span>":f},editor:Slick.Editors.Text},{id:"permissions",name:"Permissions",field:"permissions",width:70},{id:"owner",name:"Owner",field:"owner",width:70},{id:"group",name:"Group",field:"group",width:70},{id:"lastMod",name:"Last Modified",field:"last-modified",width:140}],b={editable:!1,
multiSelect:!1,forceSyncScrolling:!0,forceFitColumns:!0},e={editable:!0,autoEdit:!0,multiSelect:!0,enableCellNavigation:!0,forceSyncScrolling:!0,forceFitColumns:!0};Constr=function(b,d){var f=this;this.container=$(b);this.breadcrumbs=$(".eXide-browse-breadcrumbs",d);this.loading=!1;this.clipboard=[];this.clipboardMode="copy";this.events={activate:[],activateCollection:[],activateParent:[]};this.mode="save";this.inEditor=!1;this.collection="/db";this.data=[];this.grid=new Slick.Grid(this.container,
this.data,a,e);var h=new Slick.RowSelectionModel;this.grid.setSelectionModel(h);h.onSelectedRangesChanged.subscribe(function(){var a=h.getSelectedRows();if(0!=f.data.length){for(var b=!0,c=0;c<a.length;c++)if(a[c]<f.data.length&&f.data[a[c]]&&!f.data[a[c]].writable){b=!1;break}f.$triggerEvent("activate",[1==a.length&&f.data[a[0]]&&!f.data[a[0]].isCollection?f.data[a[0]]:null,b])}});this.grid.onDblClick.subscribe(function(a){a=f.grid.getCellFromEvent(a);if(f.data[a.row].isCollection){var b;b=".."==
f.data[a.row].name?f.collection.replace(/\/[^\/]+$/,""):f.collection+"/"+f.data[a.row].name;f.$triggerEvent("activateCollection",[b,f.data[a.row].writable]);f.update(b,!1)}else eXide.app.openSelectedDocument()});this.grid.onKeyDown.subscribe(function(a){if(!f.inEditor&&!a.shiftKey&&!a.altKey&&!a.ctrlKey)switch(a.which){case 13:a.stopPropagation();a.preventDefault();a=h.getSelectedRows();if(1==a.length)if(f.data[a[0]].isCollection){var b;b=".."==f.data[a[0]].name?f.collection.replace(/\/[^\/]+$/,""):
f.collection+"/"+f.data[a[0]].name;f.$triggerEvent("activateCollection",[b,f.data[a[0]].writable]);f.update(b,!1)}else eXide.app.openSelectedDocument();break;case 8:b=f.collection.lastIndexOf("/");0<b&&(a.stopPropagation(),a.preventDefault(),"/db"!=f.collection&&(a=f.collection.substring(0,b),f.$triggerEvent("activateCollection",[a]),f.update(a,!1)));break;case 46:f.deleteResource()}});this.grid.onBeforeEditCell.subscribe(function(a,b){f.inEditor=!0;f.oldValue=f.data[b.row].name});this.grid.onBeforeCellEditorDestroy.subscribe(function(){f.inEditor=
!1});this.grid.onCellChange.subscribe(function(a,b){f.oldValue&&$.getJSON("modules/collections.xql",{target:f.data[b.row].name,rename:f.oldValue,root:f.collection},function(a){f.reload();f.data[b.row].isCollection&&f.$triggerEvent("activateCollection",[f.data[b.row].name]);"fail"==a.status&&eXide.util.Dialog.warning("Rename Error",a.message)})});this.grid.onViewportChanged.subscribe(function(){var a=f.grid.getViewport();f.load(a.top,a.bottom)});$("#resource-properties-dialog").dialog({title:"Resource/collection properties",
modal:!0,autoOpen:!1,height:320,width:460,buttons:{Cancel:function(){$(this).dialog("close")},Apply:function(){var a=this,b=f.grid.getSelectionModel().getSelectedRows();if(0!=b.length){for(var c=[],d=0;d<b.length;d++)c.push(f.collection+"/"+f.data[b[d]].name);b=$("form",a).serialize();b=b+"&"+$.param({"modify[]":c});$.getJSON("modules/collections.xql",b,function(){$(a).dialog("close");f.reload()})}}}})};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.setCollection=function(a){this.collection=
a;this.updateBreadcrumbs()};Constr.prototype.updateBreadcrumbs=function(){this.breadcrumbs.empty();for(var a=this,b=this.collection.split("/"),f=$("<span>/</span>"),e="/",g=0;g<b.length;g++){var i=b[g];i&&0<i.length&&(e+=i+"/",i=$('<a href="#">').append(i),i.data("collection",e),f.append(i).append("/"),i.click(function(b){b.preventDefault();a.update($(this).data("collection"),!1)}))}this.breadcrumbs.html(f)};Constr.prototype.setMode=function(a){this.mode=a;"manage"==a?this.grid.setOptions(e):this.grid.setOptions(b)};
Constr.prototype.resize=function(){this.grid.resizeCanvas();this.grid.focus()};Constr.prototype.update=function(a,b){if(b||a!==this.collection)$.log("Opening resources for %s",a),this.setCollection(a),this.grid.invalidate(),this.data.length=0,this.grid.setSelectedRows([]),this.grid.onViewportChanged.notify(),this.grid.resetActiveCell(),this.grid.setActiveCell(0,1),this.grid.focus()};Constr.prototype.load=function(a,b){if(!this.loading&&(!this.data[a]||!(b>=this.data.length||this.data[b]))){var f=
this;this.loading=!0;b+=20;$.getJSON("modules/collections.xql",{root:this.collection,view:"r",start:a,end:b},function(e){f.loading=!1;for(var g=a;g<=b;g++)f.grid.invalidateRow(g);if(e&&e.items){f.data.length=e.total;for(g=0;g<e.items.length;g++)f.data[a+g]=e.items[g]}else f.data.length=0;f.grid.updateRowCount();f.grid.render();0==a&&(f.grid.resetActiveCell(),f.grid.setActiveCell(0,1),f.grid.focus())})}};Constr.prototype.hasSelection=function(){var a=this.grid.getSelectionModel().getSelectedRows();
return a&&0<a.length};Constr.prototype.getSelected=function(){var a=this.grid.getSelectionModel().getSelectedRows();if(0==a.length)return null;for(var b=[],f=0;f<a.length;f++)b.push(this.collection+"/"+this.data[a[f]].name);return b};Constr.prototype.createCollection=function(){var a=this;eXide.app.$checkLogin()&&eXide.util.Dialog.input("Create Collection",'<label for="collection">Name: </label><input type="text" name="collection" id="eXide-browse-collection-name"/>',function(){$.getJSON("modules/collections.xql",
{create:$("#eXide-browse-collection-name").val(),collection:a.collection},function(b){"fail"==b.status?eXide.util.Dialog.warning("Create Collection Error",b.message):a.reload()})})};Constr.prototype.deleteCollection=function(){var a=this;eXide.util.Dialog.input("Confirm Deletion","Are you sure you want to delete collection "+a.selected+"?",function(){$.getJSON("modules/collections.xql",{remove:a.collection},function(b){"fail"==b.status?eXide.util.Dialog.warning("Delete Collection Error",b.message):
a.reload()})})};Constr.prototype.deleteResource=function(){var a=this.grid.getSelectionModel().getSelectedRows();if(0!=a.length){for(var b=[],f=0;f<a.length;f++)b.push(this.data[a[f]].name);var e=this;eXide.util.Dialog.input("Confirm Deletion","Are you sure you want to delete the selected resources?",function(){$.log("Deleting resources %o",b);$.getJSON("modules/collections.xql",{remove:b,root:e.collection},function(a){e.reload();"fail"==a.status&&eXide.util.Dialog.warning("Delete Resource Error",
a.message)})})}};Constr.prototype.properties=function(){var a=this.grid.getSelectionModel().getSelectedRows();if(0!=a.length){for(var b=[],f=0;f<a.length;f++)b.push(this.collection+"/"+this.data[a[f]].name);$("#resource-properties-content").load("modules/collections.xql",{properties:b});$("#resource-properties-dialog").dialog("open")}};Constr.prototype.cut=function(){this.clipboardMode="move";this.copy()};Constr.prototype.copy=function(){var a=this.grid.getSelectionModel().getSelectedRows();this.clipboard=
[];for(var b=0;b<a.length;b++){var f=this.data[a[b]].name;"/"!=f.substr(0,1)&&(f=this.collection+"/"+f);this.clipboard.push(f)}$.log("Clipboard: %o",this.clipboard)};Constr.prototype.paste=function(){var a=this;$.log("Copying resources %o to %s",this.clipboard,this.collection);var b={root:this.collection};b[this.clipboardMode]=this.clipboard;$.getJSON("modules/collections.xql",b,function(b){$.log(b.status);"fail"==b.status?eXide.util.Dialog.warning("Delete Resource Error",b.message):a.reload()})};
Constr.prototype.focus=function(){this.container.find(".grid-canvas").focus()};Constr.prototype.reload=function(){this.grid.invalidate();this.data.length=0;this.update(this.collection,!0)};return Constr}();eXide.namespace("eXide.browse.Upload");
eXide.browse.Upload=function(){Constr=function(a){this.container=a;this.events={done:[]};$("#file_upload").fileUploadUI({sequentialUploads:!0,uploadTable:$("#files"),buildUploadRow:function(a,b){return $("<tr><td>"+a[b].name+'</td><td class="file_upload_progress"><div></div></td><td class="file_upload_cancel"><button class="ui-state-default ui-corner-all" title="Cancel"><span class="ui-icon ui-icon-cancel">Cancel</span></button></td></tr>')},buildDownloadRow:function(a){return a.error?$("<tr><td>"+
a.name+"</td><td>"+a.error+"</td></tr>"):null}});var b=this;$("#eXide-browse-upload-done").button().click(function(){$("#files").empty();b.$triggerEvent("done",[])})};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.update=function(a){$.log("Upload collection: %s",a);$('input[name="collection"]',this.container).val(a)};return Constr}();eXide.namespace("eXide.browse.Browser");
eXide.browse.Browser=function(){function a(a,e,c,d,f){var h=document.createElement("button");h.title=e;h.id="eXide-browse-toolbar-"+c;h.tabindex=d;e=document.createElement("img");e.src="resources/images/"+f;h.appendChild(e);a.append(h);return h}Constr=function(b){var e=this;this.mode="open";var c=$(".eXide-browse-toolbar",b),d=a(c,"Reload","reload",1,"arrow_refresh.png");$(d).click(function(){e.resources.reload(!0)});this.btnCreateCollection=a(c,"Create Collection","create",3,"folder_add.png");$(this.btnCreateCollection).click(function(a){a.preventDefault();
e.resources.createCollection()});this.btnUpload=a(c,"Upload Files","upload",4,"database_add.png");$(this.btnUpload).click(function(a){a.preventDefault();$(".eXide-browse-resources",b).hide();$(".eXide-browse-upload",b).show()});this.btnDeleteResource=a(c,"Delete","delete-resource",5,"bin.png");$(this.btnDeleteResource).click(function(a){a.preventDefault();e.deleteSelected()});this.btnProperties=a(c,"Properties","properties",10,"application_form_edit.png");$(this.btnProperties).click(function(a){a.preventDefault();
e.resources.properties()});d=a(c,"Open Selected","open",6,"page_edit.png");$(d).click(function(a){a.preventDefault();eXide.app.openSelectedDocument(!1)});this.btnCopy=a(c,"Copy","copy",7,"page_copy.png");this.btnCut=a(c,"Cut","cut",8,"cut.png");this.btnPaste=a(c,"Paste","paste",9,"page_paste.png");this.selection=$(".eXide-browse-form input",b);this.container=b;this.resources=new eXide.browse.ResourceBrowser($(".eXide-browse-resources",b),b);this.upload=new eXide.browse.Upload($(".eXide-browse-upload",
b).hide());this.layout=null;this.resources.addEventListener("activate",this,this.onActivateResource);this.resources.addEventListener("activateCollection",this,this.onActivateCollection);this.upload.addEventListener("done",this,function(){$(".eXide-browse-resources",b).show();$(".eXide-browse-upload",b).hide();this.reload()});$(this.btnCopy).click(function(a){a.preventDefault();e.resources.copy()});$(this.btnCut).click(function(a){a.preventDefault();e.resources.cut()});$(this.btnPaste).click(function(a){a.preventDefault();
e.resources.paste()})};Constr.prototype={init:function(){var a=$(this.container).innerHeight()-$(".eXide-browse-form",this.container).height()-25;$(".eXide-browse-panel",this.container).height(a);null==this.layout&&(this.layout=$(".eXide-browse-panel",this.container).layout({enableCursorHotkey:!1,north__resizable:!1,north__closable:!1,north__spacing_open:0,south__resizable:!1,west__size:200,west__initClosed:!1,center__minSize:300,onresize:function(){this.resources.resize()}}),this.resources.reload(),
this.resources.resize())},reload:function(a,e){if(a){$(".eXide-browse-toolbar button",this.container).hide();for(var c=0;c<a.length;c++)$("#eXide-browse-toolbar-"+a[c]).show()}e&&(this.mode=e);this.resources.setMode(e);this.resources.reload();"save"===this.mode?$(".eXide-browse-form",this.container).show().focus():$(".eXide-browse-form",this.container).hide();null!=this.layout&&(this.resize(),$(this.selection).val(""))},resize:function(){this.layout.resizeAll()},deleteSelected:function(){this.resources.getSelected();
this.resources.deleteResource()},getSelection:function(){var a=$(this.selection).val();return null==a||""==a?null:{name:a,path:this.resources.collection+"/"+a,writable:!0}},changeToCollection:function(a){this.resources.update(a,!0)},onActivateResource:function(a,e){a?$(this.selection).val(a.name):$(this.selection).val("");"open"!=this.mode&&e?($(this.btnDeleteResource).css("display",""),$(this.btnProperties).css("display","")):($(this.btnDeleteResource).css("display","none"),$(this.btnProperties).css("display",
"none"))},onActivateCollection:function(a,e){$.log("Activate collection: %s %s",a,this.mode);switch(this.mode){case "open":case "save":$(".eXide-browse-toolbar button",this.container).hide();$(this.btnCreateCollection).css("display","");break;default:e?($(this.btnCreateCollection).css("display",""),$(this.btnUpload).css("display",""),$(this.btnCut).css("display",""),$(this.btnPaste).css("display",""),$(this.btnDeleteResource).css("display","")):($(this.btnCreateCollection).css("display","none"),$(this.btnUpload).css("display",
"none"),$(this.btnCut).css("display","none"),$(this.btnPaste).css("display","none"),$(this.btnDeleteResource).css("display","none"))}this.upload.update(a,e)}};return Constr}();eXide.namespace("eXide.find.IncrementalSearch");
eXide.find.IncrementalSearch=function(){var a={backwards:!1,wrap:!0,caseSensitive:!1,wholeWord:!1,regExp:!1};Constr=function(a,e){var c=this;c.input=$(a);c.input.hide();c.input.keyup(function(a){switch(a.which){case 27:case 13:a.preventDefault();c.input.hide();c.editor.focus();break;case 40:a.preventDefault();c.editor.findNext();break;case 38:a.preventDefault();c.editor.findPrevious();break;default:c.onChange()}});c.editor=e};Constr.prototype.start=function(){this.currentLine=this.editor.getSession().getSelection().getSelectionLead().row;
this.input.val("");this.input.show().focus()};Constr.prototype.onChange=function(){this.editor.gotoLine(this.currentLine);var b=this.input.val();this.editor.find(b,a,!0);this.input.focus()};return Constr}();eXide.namespace("eXide.find.SearchReplace");
eXide.find.SearchReplace=function(){Constr=function(a){var b=this;b.editor=a;b.needleSet=!1;b.lastSearch=null;b.container=$("#find-replace-dialog");b.container.dialog({modal:!1,autoOpen:!1,height:300,width:600,buttons:{Close:function(){$(this).dialog("close");b.editor.focus()},Replace:function(){b.replace(!1)},"Replace All":function(){b.replace(!0)},"Find Next":function(){b.find(1)},"Find Previous":function(){b.find(-1)}}})};Constr.prototype.open=function(){this.container.dialog("open");this.container.find("input[name='search']").focus()};
Constr.prototype.find=function(a){var b=this.container.find("input[name='search']").val();$.log("Searching for %s",b);b&&0<b.length&&(null!=this.lastSearch&&this.lastSearch==b?-1==a?this.editor.findPrevious():this.editor.findNext():(this.editor.find(b,this.getOptions(),!0),this.needleSet=!0),this.editor.focus())};Constr.prototype.replace=function(a){var b=this.container.find("input[name='search']").val();if(b&&0<b.length&&(this.needleSet||(this.editor.find(b,this.getOptions(),!0),this.needleSet=!0),
(b=this.container.find("input[name='replace']").val())&&0<b.length))a?this.editor.replaceAll(b):(this.editor.replace(b),this.editor.findNext())};Constr.prototype.getOptions=function(){var a=this.container.find("input[name='case']").is(":checked"),b=this.container.find("input[name = 'regex']").is(":checked");return{wrap:!0,caseSensitive:a,regExp:b}};return Constr}();eXide.namespace("eXide.find.Modules");
eXide.find.Modules=function(){var a={open:[],"import":[]},b=[{id:"prefix",name:"Prefix",field:"prefix",sortable:!0,resizable:!0,maxWidth:100,minWidth:60},{id:"uri",name:"URI",field:"uri",sortable:!0,resizable:!0,minWidth:100},{id:"at",name:"Location",field:"at",sortable:!0,resizable:!0}],e={editable:!1,multiSelect:!1,forceFitColumns:!0},c=[],d;$(document).ready(function(){$("#select-module-dialog").dialog({modal:!1,autoOpen:!1,height:400,width:600,open:eXide.find.Modules.$init});d=new Slick.Grid("#module-list",
c,b,e);var a=new Slick.RowSelectionModel({selectActiveRow:!0});d.setSelectionModel(a);d.onDblClick.subscribe(function(a){a=d.getCellFromEvent(a);eXide.find.Modules.$triggerEvent("open",[c[a.row]])});d.onSort.subscribe(function(a,b){$.log("sorting on field: %s",b.sortCol.field);c.sort(function(a,c){var d=b.sortCol.field,e=a[d],d=c[d],e=(e==d?0:e>d?1:-1)*(b.sortAsc?1:-1);return 0!=e?e:0});d.invalidate();d.render()})});return{select:function(a){var b={Open:function(){eXide.find.Modules.trigger("open");
$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}};"xquery"==a&&(b.Import=function(){eXide.find.Modules.trigger("import");$(this).dialog("close")});$("#select-module-dialog").dialog("option","buttons",b);$("#select-module-dialog").dialog("open")},trigger:function(a){var b=d.getSelectionModel().getSelectedRows();1==b.length&&eXide.find.Modules.$triggerEvent(a,[c[b[0]]])},$init:function(){d.resizeCanvas();d.invalidate();c.length=0;$.getJSON("modules/find.xql",function(a){c.length=
a.length;for(var b=0;b<a.length;b++)c[b]=a[b];d.updateRowCount();d.render();d.setActiveCell(0,0);d.setSelectedRows([0]);$("#module-list").find(".grid-canvas").focus()})},addEventListener:function(b,c,d){(b=a[b])&&b.push({obj:c,callback:d})},$triggerEvent:function(b,c){var d=a[b];if(d)for(var e=0;e<d.length;e++)d[e].callback.apply(d[e].obj,c)}}}();eXide.namespace("eXide.util.Menubar");
eXide.util.Menubar=function(){Constr=function(a){var b=this;this.container=a;var e=!1;$("ul li",this.container).click(function(a){a.stopPropagation();$("ul li ul",b.container).css({display:"none"});$("ul",this).css({display:"block"});e=!0});$("body").click(function(){e&&$("ul li ul",b.container).css({display:"none"})})};Constr.prototype.click=function(a,b,e){var c=this;if(e){var d=eXide.edit.commands.getShortcut(e);d&&(d=d.replace(/Command/g,String.fromCharCode(8984)),d=d.replace(/Shift/g,String.fromCharCode(8679)),
d=d.replace(/Option/g,String.fromCharCode(8997)),d=d.replace(/Control/g,"^"),$(a).each(function(){var a=document.createElement("span");a.className="shortcut";a.appendChild(document.createTextNode(d));this.appendChild(a)}))}$(a).click(function(a){a.preventDefault();$("ul li ul",c.container).css({display:"none"});b()})};Constr.prototype.add=function(a,b,e,c){var d=this,a=$(this.container).find('ul li[title="'+a+'"]'),a=a.find("ul");a.append($('<li><a href="#" title="'+e+'">'+b+"</a></li>"));a.find("li:last-child a").click(function(a){a.preventDefault();
c();$("ul li ul",d.container).css({display:"none"})})};Constr.prototype.remove=function(a,b){$.log("Removing menu entry %s",b);a=$(this.container).find('ul li[title="'+a+'"]');a.find('ul li a[title = "'+b+'"]').remove()};return Constr}();